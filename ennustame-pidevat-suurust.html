<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Bayesi statistika kasutades R keelt</title>
  <meta name="description" content="Praktilise kursuse ‘Reprodutseeritav andmeanalüüs R keeles’ materjalid.">
  <meta name="generator" content="bookdown 0.5 and GitBook 2.6.7">

  <meta property="og:title" content="Bayesi statistika kasutades R keelt" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="img/cyclo.png" />
  <meta property="og:description" content="Praktilise kursuse ‘Reprodutseeritav andmeanalüüs R keeles’ materjalid." />
  <meta name="github-repo" content="rstats-tartu/lectures" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Bayesi statistika kasutades R keelt" />
  
  <meta name="twitter:description" content="Praktilise kursuse ‘Reprodutseeritav andmeanalüüs R keeles’ materjalid." />
  <meta name="twitter:image" content="img/cyclo.png" />

<meta name="author" content="Taavi Päll, Ülo Maiväli">


<meta name="date" content="2017-10-31">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="mudelite-keel.html">
<link rel="next" href="sonastik.html">
<script src="libs/jquery/jquery.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />








<script src="https://use.fontawesome.com/e4ba4259a1.js"></script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Reprodutseeritav andmeanalüüs R programmiga</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Haara kannel, Vanemuine!</a></li>
<li class="chapter" data-level="1" data-path="sissejuhatus-maailm-teooria-ja-mudel.html"><a href="sissejuhatus-maailm-teooria-ja-mudel.html"><i class="fa fa-check"></i><b>1</b> Sissejuhatus: maailm, teooria ja mudel</a><ul>
<li class="chapter" data-level="" data-path="sissejuhatus-maailm-teooria-ja-mudel.html"><a href="sissejuhatus-maailm-teooria-ja-mudel.html#suur-ja-vaike-maailm"><i class="fa fa-check"></i>Suur ja väike maailm</a></li>
<li class="chapter" data-level="" data-path="sissejuhatus-maailm-teooria-ja-mudel.html"><a href="sissejuhatus-maailm-teooria-ja-mudel.html#mudeli-vaike-maailm"><i class="fa fa-check"></i>Mudeli väike maailm</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="lineaarsed-mudelid.html"><a href="lineaarsed-mudelid.html"><i class="fa fa-check"></i><b>2</b> Lineaarsed mudelid</a><ul>
<li class="chapter" data-level="2.1" data-path="lineaarsed-mudelid.html"><a href="lineaarsed-mudelid.html#ennustus-lineaarsest-mudelist"><i class="fa fa-check"></i><b>2.1</b> Ennustus lineaarsest mudelist</a></li>
<li class="chapter" data-level="" data-path="lineaarsed-mudelid.html"><a href="lineaarsed-mudelid.html#neli-moistet"><i class="fa fa-check"></i>Neli mõistet</a></li>
<li class="chapter" data-level="" data-path="lineaarsed-mudelid.html"><a href="lineaarsed-mudelid.html#mudeli-fittimine"><i class="fa fa-check"></i>Mudeli fittimine</a></li>
<li class="chapter" data-level="" data-path="lineaarsed-mudelid.html"><a href="lineaarsed-mudelid.html#ule--ja-alafittimine"><i class="fa fa-check"></i>Üle- ja alafittimine</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="kaks-lineaarse-mudeli-laiendust.html"><a href="kaks-lineaarse-mudeli-laiendust.html"><i class="fa fa-check"></i><b>3</b> Kaks lineaarse mudeli laiendust</a><ul>
<li class="chapter" data-level="" data-path="kaks-lineaarse-mudeli-laiendust.html"><a href="kaks-lineaarse-mudeli-laiendust.html#mitme-soltumatu-prediktoriga-mudel"><i class="fa fa-check"></i>Mitme sõltumatu prediktoriga mudel</a></li>
<li class="chapter" data-level="" data-path="kaks-lineaarse-mudeli-laiendust.html"><a href="kaks-lineaarse-mudeli-laiendust.html#interaktsioonimudel---uhe-prediktori-moju-soltub-teise-prediktori-vaartusest"><i class="fa fa-check"></i>Interaktsioonimudel - ühe prediktori mõju sõltub teise prediktori väärtusest</a></li>
<li class="chapter" data-level="" data-path="kaks-lineaarse-mudeli-laiendust.html"><a href="kaks-lineaarse-mudeli-laiendust.html#veamudel"><i class="fa fa-check"></i>Veamudel</a><ul>
<li class="chapter" data-level="" data-path="kaks-lineaarse-mudeli-laiendust.html"><a href="kaks-lineaarse-mudeli-laiendust.html#enimkasutatud-veamudel-on-normaaljaotus"><i class="fa fa-check"></i>Enimkasutatud veamudel on normaaljaotus</a></li>
<li class="chapter" data-level="" data-path="kaks-lineaarse-mudeli-laiendust.html"><a href="kaks-lineaarse-mudeli-laiendust.html#normaaljaotuse-mudel-vaikestel-valimitel"><i class="fa fa-check"></i>Normaaljaotuse mudel väikestel valimitel</a></li>
<li class="chapter" data-level="" data-path="kaks-lineaarse-mudeli-laiendust.html"><a href="kaks-lineaarse-mudeli-laiendust.html#normaaljaotuse-ja-lognormaaljaotuse-erilisus"><i class="fa fa-check"></i>Normaaljaotuse ja lognormaaljaotuse erilisus</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="kusimused-mida-statistika-kusib.html"><a href="kusimused-mida-statistika-kusib.html"><i class="fa fa-check"></i><b>4</b> Küsimused, mida statistika küsib</a><ul>
<li class="chapter" data-level="" data-path="kusimused-mida-statistika-kusib.html"><a href="kusimused-mida-statistika-kusib.html#kuidas-naevad-valja-teie-andmed"><i class="fa fa-check"></i>Kuidas näevad välja teie andmed?</a><ul>
<li class="chapter" data-level="" data-path="kusimused-mida-statistika-kusib.html"><a href="kusimused-mida-statistika-kusib.html#summaarsed-statistikud"><i class="fa fa-check"></i>Summaarsed statistikud</a></li>
<li class="chapter" data-level="" data-path="kusimused-mida-statistika-kusib.html"><a href="kusimused-mida-statistika-kusib.html#keskvaartused"><i class="fa fa-check"></i>Keskväärtused</a></li>
<li class="chapter" data-level="" data-path="kusimused-mida-statistika-kusib.html"><a href="kusimused-mida-statistika-kusib.html#muutuja-sisene-varieeruvus"><i class="fa fa-check"></i>Muutuja sisene varieeruvus</a></li>
<li class="chapter" data-level="" data-path="kusimused-mida-statistika-kusib.html"><a href="kusimused-mida-statistika-kusib.html#logaritmi-andmed"><i class="fa fa-check"></i>Logaritmi andmed</a></li>
<li class="chapter" data-level="" data-path="kusimused-mida-statistika-kusib.html"><a href="kusimused-mida-statistika-kusib.html#iseloomusta-andmeid-algses-skaalas-mediaan-mad"><i class="fa fa-check"></i>Iseloomusta andmeid algses skaalas: mediaan (MAD)</a></li>
<li class="chapter" data-level="" data-path="kusimused-mida-statistika-kusib.html"><a href="kusimused-mida-statistika-kusib.html#muutujate-koos-varieeruvus"><i class="fa fa-check"></i>Muutujate koos-varieeruvus</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="kusimused-mida-statistika-kusib.html"><a href="kusimused-mida-statistika-kusib.html#jata-meelde"><i class="fa fa-check"></i>Jäta meelde</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="eda-eksploratoorne-andmeanaluus.html"><a href="eda-eksploratoorne-andmeanaluus.html"><i class="fa fa-check"></i><b>5</b> EDA — eksploratoorne andmeanalüüs</a><ul>
<li class="chapter" data-level="5.1" data-path="eda-eksploratoorne-andmeanaluus.html"><a href="eda-eksploratoorne-andmeanaluus.html#kokkuvote"><i class="fa fa-check"></i><b>5.1</b> Kokkuvõte</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="jareldav-statistika.html"><a href="jareldav-statistika.html"><i class="fa fa-check"></i><b>6</b> Järeldav statistika</a><ul>
<li class="chapter" data-level="" data-path="jareldav-statistika.html"><a href="jareldav-statistika.html#jareldav-statistika-on-toenaosusteooria-kaepikendus"><i class="fa fa-check"></i>Järeldav statistika on tõenäosusteooria käepikendus</a></li>
<li class="chapter" data-level="" data-path="jareldav-statistika.html"><a href="jareldav-statistika.html#formaalsed-tuletused-toenaosusteooria-aksioomidest"><i class="fa fa-check"></i>Formaalsed tuletused tõenäosusteooria aksioomidest</a><ul>
<li class="chapter" data-level="" data-path="jareldav-statistika.html"><a href="jareldav-statistika.html#bayesi-teoreemi-rakendamine-diskreetsetele-hupoteesidele"><i class="fa fa-check"></i>Bayesi teoreemi rakendamine diskreetsetele hüpoteesidele</a></li>
<li class="chapter" data-level="" data-path="jareldav-statistika.html"><a href="jareldav-statistika.html#toenaosuse-tolgendus"><i class="fa fa-check"></i>Tõenäosuse tõlgendus</a></li>
<li class="chapter" data-level="" data-path="jareldav-statistika.html"><a href="jareldav-statistika.html#toenaosusteooriast-tulenevad-statistika-pohiprintsiibid"><i class="fa fa-check"></i>Tõenäosusteooriast tulenevad statistika põhiprintsiibid</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="jareldav-statistika.html"><a href="jareldav-statistika.html#andmed-ei-ole-sama-mis-tegelikkus"><i class="fa fa-check"></i>Andmed ei ole sama, mis tegelikkus</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="bootstrappimine.html"><a href="bootstrappimine.html"><i class="fa fa-check"></i><b>7</b> Bootstrappimine</a><ul>
<li class="chapter" data-level="" data-path="bootstrappimine.html"><a href="bootstrappimine.html#veidi-keerulisem-bootstrap"><i class="fa fa-check"></i>Veidi keerulisem bootstrap</a></li>
<li class="chapter" data-level="" data-path="bootstrappimine.html"><a href="bootstrappimine.html#bayesboot"><i class="fa fa-check"></i>bayesboot()</a></li>
<li class="chapter" data-level="" data-path="bootstrappimine.html"><a href="bootstrappimine.html#parameetriline-bootstrap"><i class="fa fa-check"></i>Parameetriline bootstrap</a></li>
<li class="chapter" data-level="" data-path="bootstrappimine.html"><a href="bootstrappimine.html#bootstrappimine-ei-ole-kogu-tode"><i class="fa fa-check"></i>Bootstrappimine ei ole kogu tõde</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="bayesi-pohimote.html"><a href="bayesi-pohimote.html"><i class="fa fa-check"></i>Bayesi põhimõte</a><ul>
<li class="chapter" data-level="" data-path="bayesi-pohimote.html"><a href="bayesi-pohimote.html#esimene-naide"><i class="fa fa-check"></i>Esimene näide</a></li>
<li class="chapter" data-level="" data-path="bayesi-pohimote.html"><a href="bayesi-pohimote.html#teine-naide-sonastame-oma-probleemi-umber"><i class="fa fa-check"></i>Teine näide: sõnastame oma probleemi ümber</a></li>
<li class="chapter" data-level="" data-path="bayesi-pohimote.html"><a href="bayesi-pohimote.html#kui-n-1"><i class="fa fa-check"></i>Kui n = 1</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mudelite-keel.html"><a href="mudelite-keel.html"><i class="fa fa-check"></i>Mudelite keel</a><ul>
<li class="chapter" data-level="" data-path="mudelite-keel.html"><a href="mudelite-keel.html#beta-prior"><i class="fa fa-check"></i>Beta prior</a></li>
<li class="chapter" data-level="" data-path="mudelite-keel.html"><a href="mudelite-keel.html#prioritest-uldiselt"><i class="fa fa-check"></i>Prioritest üldiselt</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html"><i class="fa fa-check"></i><b>8</b> Ennustame Pidevat suurust</a><ul>
<li class="chapter" data-level="" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#lihtne-normaaljaotuse-mudel"><i class="fa fa-check"></i>Lihtne normaaljaotuse mudel</a><ul>
<li class="chapter" data-level="8.0.1" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#kui-lai-on-meie-toeparafunktsioon"><i class="fa fa-check"></i><b>8.0.1</b> Kui lai on meie tõepärafunktsioon?</a></li>
<li class="chapter" data-level="8.0.2" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#lihtne-voi-robustne-normaalne-mudel"><i class="fa fa-check"></i><b>8.0.2</b> Lihtne või robustne normaalne mudel?</a></li>
<li class="chapter" data-level="8.0.3" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#mcmc-ahelate-kvaliteet"><i class="fa fa-check"></i><b>8.0.3</b> MCMC ahelate kvaliteet</a></li>
<li class="chapter" data-level="8.0.4" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#naide-usa-presidentide-keskmine-pikkus"><i class="fa fa-check"></i><b>8.0.4</b> Näide: USA presidentide keskmine pikkus</a></li>
</ul></li>
<li class="chapter" data-level="8.1" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#lineaarne-regressioon"><i class="fa fa-check"></i><b>8.1</b> Lineaarne regressioon</a></li>
<li class="chapter" data-level="8.2" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#lm---vahimruutude-meetodiga-fititud-lineaarsed-mudelid"><i class="fa fa-check"></i><b>8.2</b> <code>lm()</code> - vähimruutude meetodiga fititud lineaarsed mudelid</a></li>
<li class="chapter" data-level="8.3" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#bayesi-meetodil-lineaarse-mudeli-fittimine"><i class="fa fa-check"></i><b>8.3</b> Bayesi meetodil lineaarse mudeli fittimine</a></li>
<li class="chapter" data-level="8.4" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#ennustused-mudelist"><i class="fa fa-check"></i><b>8.4</b> Ennustused mudelist</a><ul>
<li class="chapter" data-level="8.4.1" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#lognormaalne-toeparamudel"><i class="fa fa-check"></i><b>8.4.1</b> Lognormaalne tõepäramudel</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#mitme-prediktoriga-lineaarne-regressioon"><i class="fa fa-check"></i><b>8.5</b> Mitme prediktoriga lineaarne regressioon</a><ul>
<li class="chapter" data-level="8.5.1" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#mudeldamine-standardiseeritud-andmetega."><i class="fa fa-check"></i><b>8.5.1</b> Mudeldamine standardiseeritud andmetega.</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#keerulisemate-mudelitega-tootamine"><i class="fa fa-check"></i><b>8.6</b> Keerulisemate mudelitega töötamine</a><ul>
<li class="chapter" data-level="8.6.1" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#predictor-residual-plots."><i class="fa fa-check"></i><b>8.6.1</b> Predictor residual plots.</a></li>
<li class="chapter" data-level="8.6.2" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#posterior-prediction-plots"><i class="fa fa-check"></i><b>8.6.2</b> Posterior prediction plots</a></li>
<li class="chapter" data-level="8.6.3" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#interaktsioonid-prediktorite-vahel"><i class="fa fa-check"></i><b>8.6.3</b> interaktsioonid prediktorite vahel</a></li>
<li class="chapter" data-level="8.6.4" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#interaktsioonid-pidevatele-tunnustele"><i class="fa fa-check"></i><b>8.6.4</b> Interaktsioonid pidevatele tunnustele</a></li>
</ul></li>
<li class="chapter" data-level="8.7" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#hierarhilised-mudelid"><i class="fa fa-check"></i><b>8.7</b> Hierarhilised mudelid</a><ul>
<li class="chapter" data-level="8.7.1" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#shrinkage"><i class="fa fa-check"></i><b>8.7.1</b> Shrinkage</a></li>
<li class="chapter" data-level="8.7.2" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#anova-laadne-mudel"><i class="fa fa-check"></i><b>8.7.2</b> ANOVA-laadne mudel</a></li>
<li class="chapter" data-level="8.7.3" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#vabad-interceptid-klassikalises-regressioonimudelis"><i class="fa fa-check"></i><b>8.7.3</b> Vabad interceptid klassikalises regressioonimudelis</a></li>
<li class="chapter" data-level="8.7.4" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#vabad-tousud-ja-interceptid"><i class="fa fa-check"></i><b>8.7.4</b> Vabad tõusud ja interceptid</a></li>
<li class="chapter" data-level="8.7.5" data-path="ennustame-pidevat-suurust.html"><a href="ennustame-pidevat-suurust.html#hierarhiline-mudel-pidevate-prediktoritega"><i class="fa fa-check"></i><b>8.7.5</b> Hierarhiline mudel pidevate prediktoritega</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="sonastik.html"><a href="sonastik.html"><i class="fa fa-check"></i><b>9</b> Sõnastik</a></li>
<li class="chapter" data-level="" data-path="bibliograafia.html"><a href="bibliograafia.html"><i class="fa fa-check"></i>Bibliograafia</a></li>
<li class="chapter" data-level="10" data-path="bayesi-ja-sagedusliku-statistika-vordlus.html"><a href="bayesi-ja-sagedusliku-statistika-vordlus.html"><i class="fa fa-check"></i><b>10</b> Bayesi ja sagedusliku statistika võrdlus</a><ul>
<li class="chapter" data-level="10.1" data-path="bayesi-ja-sagedusliku-statistika-vordlus.html"><a href="bayesi-ja-sagedusliku-statistika-vordlus.html#kaks-statistikat-ajaloost-ja-toenaosusest"><i class="fa fa-check"></i><b>10.1</b> Kaks statistikat: ajaloost ja tõenäosusest</a></li>
<li class="chapter" data-level="10.2" data-path="bayesi-ja-sagedusliku-statistika-vordlus.html"><a href="bayesi-ja-sagedusliku-statistika-vordlus.html#poleemika-kumbki-toenaosus-pole-paris-see-mida-uldiselt-arvatakse"><i class="fa fa-check"></i><b>10.2</b> Poleemika: kumbki tõenäosus pole päris see, mida üldiselt arvatakse</a></li>
<li class="chapter" data-level="10.3" data-path="bayesi-ja-sagedusliku-statistika-vordlus.html"><a href="bayesi-ja-sagedusliku-statistika-vordlus.html#vordlev-naide-kahe-grupi-vordlus"><i class="fa fa-check"></i><b>10.3</b> Võrdlev näide: kahe grupi võrdlus</a><ul>
<li class="chapter" data-level="10.3.1" data-path="bayesi-ja-sagedusliku-statistika-vordlus.html"><a href="bayesi-ja-sagedusliku-statistika-vordlus.html#bayesiaan"><i class="fa fa-check"></i><b>10.3.1</b> Bayesiaan</a></li>
<li class="chapter" data-level="10.3.2" data-path="bayesi-ja-sagedusliku-statistika-vordlus.html"><a href="bayesi-ja-sagedusliku-statistika-vordlus.html#sageduslik-statistik"><i class="fa fa-check"></i><b>10.3.2</b> Sageduslik statistik</a></li>
<li class="chapter" data-level="10.3.3" data-path="bayesi-ja-sagedusliku-statistika-vordlus.html"><a href="bayesi-ja-sagedusliku-statistika-vordlus.html#tulemuste-tolgendamine"><i class="fa fa-check"></i><b>10.3.3</b> Tulemuste tõlgendamine</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="bayesi-ja-sagedusliku-statistika-vordlus.html"><a href="bayesi-ja-sagedusliku-statistika-vordlus.html#kahe-paradigma-erinevused"><i class="fa fa-check"></i><b>10.4</b> Kahe paradigma erinevused</a></li>
<li class="chapter" data-level="10.5" data-path="bayesi-ja-sagedusliku-statistika-vordlus.html"><a href="bayesi-ja-sagedusliku-statistika-vordlus.html#statistiline-ennustus-kui-mitmetasandiline-protsess"><i class="fa fa-check"></i><b>10.5</b> Statistiline ennustus kui mitmetasandiline protsess</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstats-tartu/lectures" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Bayesi statistika kasutades R keelt</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="ennustame-pidevat-suurust" class="section level1">
<h1><span class="header-section-number">8</span> Ennustame Pidevat suurust</h1>
<div id="lihtne-normaaljaotuse-mudel" class="section level2 unnumbered">
<h2>Lihtne normaaljaotuse mudel</h2>
<p>Kui me eelmises peatükis modelleerisime diskreetseid binaarseid sündmusi (elus või surnud) üle binoomjaotuse, siis edasi tegeleme pidevate suurustega ehk parameetritega, millele saab omistada iga väärtuse vahemikus -Inf kuni Inf.</p>
<p>Proovime veelkord USA presidentide keskmist pikkust ennustada (sama näide oli bootstrappimisel). Selleks on meil on vaja kahte asja: (1) tõepära mudelit ning (2) igale tõepära mudeli parameetrile oma priorit.</p>
<p>Selline on täismudeli (tõepära ja priorid) struktuur:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">heights <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(mu, sigma),  <span class="co"># normal likelihood</span>
mu <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">200</span>), <span class="co"># normal prior for mean</span>
sigma <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>, <span class="dv">20</span>) <span class="co">#half-cauchy prior for sd </span></code></pre></div>
<p>Tõepära on siin modeleeritud normaaljaotusena, milles on 2 tuunitavat parameetrit: mu (keskmine) ja sigma (standardhälve). Pelgalt nende kahe parameetri fikseerimine annab meile unikaalse normaaljaotuse. See, et keskmise pikkuse prior on tsentreeritud nullile viib õige pisukesele (nõnda laia priori juures küll pigem märkamatule) mu hinnangu nihkumisele nulli suunas. Selle nihke õigustus on püüd vältida mudeli üle-fittimist ehk teisisõnu ülespoole kallutatud hinnangut keskmisele pikkusele. Sama hästi võiksime kasutada ka priorit <em>mu ~ dnorm(mean = 178, sd = 10)</em>, kus 178 on ameerika meeste keskmine pikkus.</p>
<p>Alati tasub mudeli priorid välja plottida, et veenduda, et nad tõesti kajastavad meile taustateadmisi ja on sobivas parameetrivahemikus (bayesi programmide default priorid on sageli kas liiga laiad või vastupidi eeldavad, et parameetriväärtused jäävad alla 10 ühiku).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="dv">0</span><span class="op">:</span><span class="dv">100</span>
y &lt;-<span class="st"> </span><span class="kw">dcauchy</span>(x, <span class="dv">0</span>, <span class="dv">20</span>)
<span class="kw">plot</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="dt">type =</span> <span class="st">&quot;l&quot;</span> , <span class="dt">main =</span> <span class="st">&quot;Cauchy prior for sd&quot;</span>)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-103"></span>
<img src="main_files/figure-html/unnamed-chunk-103-1.pdf" alt="Cauchy prior" width="288" />
<p class="caption">
Joonis 8.1: Cauchy prior
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="dv">150</span><span class="op">:</span><span class="dv">200</span>
y &lt;-<span class="st"> </span><span class="kw">dnorm</span>(x, <span class="dv">0</span>, <span class="dv">200</span>)
<span class="kw">plot</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="dt">type =</span> <span class="st">&quot;l&quot;</span>, <span class="dt">main =</span> <span class="st">&quot;Normal prior for mu&quot;</span>)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-104"></span>
<img src="main_files/figure-html/unnamed-chunk-104-1.pdf" alt="Normaaljaptuse prior" width="288" />
<p class="caption">
Joonis 8.2: Normaaljaptuse prior
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="dv">150</span><span class="op">:</span><span class="dv">200</span>
y &lt;-<span class="st"> </span><span class="kw">dnorm</span>(x, <span class="dv">178</span>, <span class="dv">10</span>)
<span class="kw">plot</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="dt">type =</span> <span class="st">&quot;l&quot;</span>, <span class="dt">main =</span> <span class="st">&quot;Another normal prior for mu&quot;</span>)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-105"></span>
<img src="main_files/figure-html/unnamed-chunk-105-1.pdf" alt="veel &lt;U+00FC&gt;ks Normaaljaptuse prior." width="288" />
<p class="caption">
Joonis 8.3: veel <U+00FC>ks Normaaljaptuse prior.
</p>
</div>
<p>Siin on valida kahe priori vahel mu-le. Võib-olla eelistaksid sina mõnda kolmandat? Kui jah, siis pole muud kui tee valmis ja kasuta!</p>
<p>Sama hästi võiksime tõepära modelleerida ka mõne muu jaotusega (Studenti t jaotus, eksponentsiaalne jaotus, lognormaaljaotus jne). Sel juhul oleksid meil erinevad parameetrid, mida tuunida, aga põhimõte on sama. Bayes on modulaarne — kui sa põhimõtet tead, pole tehniliselt suurt vahet, millist mudelit soovid kasutada.</p>
<p>Näiteks:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">heights <span class="op">~</span><span class="st"> </span><span class="kw">student_t</span>(nu, mu, sigma) , <span class="co"># t likelihood</span>
nu<span class="op">~</span><span class="st"> </span><span class="kw">dunif</span>( <span class="dv">1</span>, <span class="dv">100</span>), <span class="co"># uniform prior for the shape parameter</span>
mu <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">200</span>), <span class="co"># normal prior for mean</span>
sigma <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>, <span class="dv">20</span>) <span class="co"># half-cauchy prior for sd</span></code></pre></div>
<p>Normaaljaotusel on 2 parameetrit, millele posteerior arvutada: mu (mean) ja sigma (sd). Seega on vaja ka kahte priorit, üks mu-le ja teine sigma-le. Studenti t jaotuse korral lisandub veel üks parameeter: nu ehk jaotuse kuju määrav parameeter. nu-d saab tuunida 1 ja lõpmatuse vahel. Mida väiksem on nu, seda paksemad tulevad jaotuse sabad. Kui nu on suur, siis on t jaotuse kuju sama, mis normaaljaotusel. Siin andsime nu-le tasase priori 1 ja 100 vahel, hiljem proovime ka teisi prioreid nu-le.</p>
<p>Studenti t jaotus on põnev alternatiiv normaaljaotusele, sest see on vähem tundlik outlieritele. Kuna normaaljaotus langeb servades väga kiiresti siis, kui meil on mõni andmepunkt, mis jääb jaotuse tipust kaugele, on ainus võimalus selle punkti normaaljaotuse alla mahutamiseks omistada jaotusele väga suur standardhälve. See muudab outlierit sisaldava normaaljaotuse ülemäära laiaks, mis viib analüüsis asjatult kaotatud efektidele. Seevastu t jaotuse sabasid saab nu abil üles-alla liigutada vastavalt sellele, kas andmed sisaldavad outliereid (selleks tuleb lihtsalt fittida nu parameeter andmete põhjal).</p>
<p>Outlierid toovad meile paksema sabaga jaotuse, mis tipu ümber ei lähe aga kaugeltki nii laiaks, kui samade andmetega fititud normaaljaotus.</p>
<div id="kui-lai-on-meie-toeparafunktsioon" class="section level3">
<h3><span class="header-section-number">8.0.1</span> Kui lai on meie tõepärafunktsioon?</h3>
<p>Normaaljaotusega modelleeritud tõepärafunktsioon on normaaljaotus, mille <code>keskväärtus = mean(valim)</code> ja mille <code>standardhälve = sd(valim) / sqrt(N)</code>, kus N on valimi suurus. See tõepärafunktsioon modelleerib meie valimi keskväärtuse kohtamise tõenäosust igal võimalikul parameetriväärtusel. Kui oleme huvitatud USA presidentide keskmisest pikkusest, siis tõepärafunktsioon ütleb iga võimaliku pikkuse kohta, millise tõenäosusega kohtaksime oma valimi keskväärtust juhul, kui just see oleks tegelik presidentide keskmine pikkus. Sigma, mille posteeriori me mudelist arvutame, on aga standardhälve algsete andmepunktide tasemel. See on väga oluline eristus, sest sigma kaudu saab simueerida uusi andmepunkte.</p>
</div>
<div id="lihtne-voi-robustne-normaalne-mudel" class="section level3">
<h3><span class="header-section-number">8.0.2</span> Lihtne või robustne normaalne mudel?</h3>
<p>Proovime mudeldada simuleeritud andmete keskväärtust.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">890775</span>)
a &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">20</span>, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">1</span>) <span class="co"># expected mean = 0, sd = 1</span>
b &lt;-<span class="st"> </span><span class="kw">c</span>(a, <span class="dv">5</span>, <span class="dv">9</span>) <span class="co"># plus 2 outliers</span></code></pre></div>
<p>Siin kasutame andmeid, mille keskväärtus on 0.38 ja sd = 1 ja millele on lisatud kaks outlierit (5 ja 9). Proovime neid andmeid mudeldada normaaljaotusega tõepäramudeliga ja seejärel üle studenti t jaotuse. Me fitime 4 mudelit, neist 3 koos outlieritega. Mudeli fittimine käib nii, et mcmc ahelad sammuvad parameetriruumis ja iga samm annab meile ühe juhusliku väärtuse posteeriorist. Defaultina on meil üks ahel, mis teeb 1000 sammu (seda saab muuta: vt <code>?map2stan</code>). Kuna ahelad veedavad rohkem aega seal, kus posterioorne tõenäosuspilv on tihedam, siis saab nõnda sämplitud posteeriori juhuvalimi histogrammist posterioorse jaotuse kuju. Veelgi enam, selle asemel, et tegeleda posterioorsete jaotuste matemaatilise analüüsiga (integreerimisega) võime analüüsida oma mcmc sämpleid otse, mis tähendab, et kõrgema matemaatika asemel vajame 2. klassi aritmeetikat.</p>
<p>Kõigepealt ilma outlieriteta mudel normaalse tõepärafuktsiooniga. Me kasutame sd priorina pool-Cauchy jaotust, mille tipp on 0 kohal ja millel on piisavalt paks saba suuremate numbrite poole. See on väheinformatiivne prior, mis on nähtud sd-de puhul mcmc algoritmides hästi töötavat. Andmed võime <code>map2stan()</code> funktsiooni sisestada nii listina kui data.frame-na (aga mitte tibble kujul).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Ilma outlierita andmed</span>
m0 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(
  <span class="kw">alist</span>(
    y <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(mu, sigma),  <span class="co"># normal likelihood</span>
    mu <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="co"># normal prior for mean</span>
    sigma <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>, <span class="fl">2.5</span>) <span class="co"># half-cauchy prior from sd </span>
  ),
  <span class="dt">data =</span> <span class="kw">list</span>(<span class="dt">y =</span> a))</code></pre></div>
<p>Sama mudel, aga outlieritega andmed. <code>map2stan()</code> tõlgib sisestatud mudeli Stan keelde ja see mudel kompileeritakse C++ keelde, milles on kodeeritud Stani mcmc mootor. Kuna kompileerimine on ajakulukas, kasutame m1 fittimiseks rstan raamatukogu (see loetakse sisse rethinkingu depency-na) ja juba komplieeritud m0 mudelit, millele lisame andmed kahe elemendina: N annab andmete arvu ja y tegelikud andmeväärtused. Selline andmete sisestamise viis on omane Stanile - <code>map2stan()</code> arvutab ise kapoti all N-i.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m1 &lt;-<span class="st"> </span><span class="kw">stan</span>(<span class="dt">fit =</span> m0<span class="op">@</span>stanfit,
           <span class="dt">data =</span> <span class="kw">list</span>(<span class="dt">N =</span> <span class="kw">length</span>(b), 
                       <span class="dt">y =</span> b),
           <span class="dt">chains =</span> <span class="dv">4</span>)</code></pre></div>
<p>Nüüd studenti t jaotusega tõepäramudel. Argumendid cores = 4, chains = 4 tähendavad, et me jooksutame 4 mcmc ahelat kasutades selleks oma arvuti 4 tuuma. Mudeli m2 juures tähendab argument constraints(list(nu = “lower=1”)), et mcmc sämpleri ahelad ei lähe kunagi allapoole ühte. See on siin kuna definitsiooni kohaselt ei saa nu olla väiksem kui 1. Argument start annab listi, mis annab iga parameetri jaoks väärtuse, millest mcmc ahel posteeriori sämplimist alustab. See on vahest vajalik, sest kui mcmc ahelad hakkavad posteeriori tõenäosuspilve otsima kaugel selle tegelikust asukohast n-mõõtmelises ruumis (n = mudeli parameetrite arv), siis võib juhtuda, et mudeli fittimine ebaõnnestub ja te saate veateate.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m2 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(
  <span class="kw">alist</span>(
    y <span class="op">~</span><span class="st"> </span><span class="kw">student_t</span>(nu, mu, sigma),
    nu <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">5</span>, <span class="dv">10</span>), 
    mu <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, <span class="dv">5</span>),
    sigma <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>, <span class="fl">2.5</span>)
    ),
  <span class="dt">data =</span> <span class="kw">list</span>(<span class="dt">y =</span> b),
  <span class="dt">constraints =</span> <span class="kw">list</span>(<span class="dt">nu =</span> <span class="st">&quot;lower=1&quot;</span>),
  <span class="dt">start =</span> <span class="kw">list</span>(<span class="dt">mu =</span> <span class="kw">mean</span>(b), <span class="dt">sigma =</span> <span class="kw">sd</span>(b), <span class="dt">nu =</span> <span class="dv">10</span>),
  <span class="dt">cores =</span> <span class="dv">4</span>,
  <span class="dt">chains =</span> <span class="dv">4</span>
)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m2 &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;data/stan_m2.rds&quot;</span>)
m2<span class="op">@</span>stanfit</code></pre></div>
<pre><code>## Inference for Stan model: y ~ student_t(nu, mu, sigma).
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##         mean se_mean   sd   2.5%    25%    50%    75%
## mu      0.28    0.00 0.22  -0.11   0.14   0.27   0.41
## sigma   0.78    0.01 0.27   0.39   0.59   0.74   0.92
## nu      2.21    0.04 1.48   1.04   1.39   1.84   2.53
## dev    78.68    0.10 3.35  74.84  76.19  77.81  80.25
## lp__  -27.23    0.04 1.45 -31.06 -27.86 -26.88 -26.16
##        97.5% n_eff Rhat
## mu      0.76  2066    1
## sigma   1.40  1254    1
## nu      5.57  1644    1
## dev    87.47  1057    1
## lp__  -25.55  1323    1
## 
## Samples were drawn using NUTS(diag_e) at Mon Oct 23 15:51:33 2017.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<p>Ja viimasena studenti t mudel, kus nu on fikseeritud konstandina. Kuna me ei fiti nu-d mudeli parameetrina, pole meil vaja ka priorit nu-le. Me teeme selle mudeli, sest nu täpsel väärtusel pole väga suurt mõju tulemustele. Me lihtsalt fikseerime nu suvalisele väärtusele, mis annab t jaotusele piisavalt paksud sabad.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m3 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(
  <span class="kw">alist</span>(
    y <span class="op">~</span><span class="st"> </span><span class="kw">student_t</span>(<span class="dv">4</span>, mu, sigma),
    mu <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, <span class="dv">5</span>),
    sigma <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>, <span class="fl">2.5</span>)
  ),
  <span class="dt">data =</span> <span class="kw">list</span>(<span class="dt">y =</span> b),
  <span class="dt">constraints =</span> <span class="kw">list</span>(<span class="dt">nu =</span> <span class="st">&quot;lower=1&quot;</span>),
  <span class="dt">start =</span> <span class="kw">list</span>(<span class="dt">mu =</span> <span class="kw">mean</span>(b), <span class="dt">sigma =</span> <span class="kw">sd</span>(b)),
  <span class="dt">cores =</span> <span class="dv">4</span>,
  <span class="dt">chains =</span> <span class="dv">4</span>)</code></pre></div>
<p>Üks esimesi asju mida koos parameetrite vaatamisega teha on lisaks vaadata, kas ka ahelad konvergeerusid. Selleks saab mugavalt kasutada <code>rethinking::tracerplot()</code> funktsiooni.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tracerplot</span>(m2)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-116"></span>
<img src="main_files/figure-html/unnamed-chunk-116-1.pdf" alt="Traceplot markovi ahelate inspekteerimiseks" width="672" />
<p class="caption">
Joonis 8.4: Traceplot markovi ahelate inspekteerimiseks
</p>
</div>
<p>Pildilt on näha, et neli ahelat (4 värvi) on hästi konvergeerunud. Hall ala on nn warmup ala, mille tulemusi ei salvestata. Muidu astub iga ahel sammu kaupa ja iga edukas samm salvestatakse ühe posteeriori väärtusena. Ahel sämplib korraga mu, sigma ja nu väärtusi n-mõõtmelises ruumis (n = mudeli parameetrite arv), mis tähendab, et ahela iga samm salvestatakse n kõrvuti numbrina.</p>
<p>Kui näit sigma kõrgema väärtusega kaasneb keskeltäbi kõrgem (või madalam) mu väärtus, on sigma ja mu omavahel korreleeritud. Et kontrollida parameetrite posterioorsete väärtuste korrelatsioone kasutame funktsiooni <code>rethinking::pairs()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">pairs</span>(m2)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-117"></span>
<img src="main_files/figure-html/unnamed-chunk-117-1.pdf" alt="korrelatsiooniplot mudeli parameetritele." width="672" />
<p class="caption">
Joonis 8.5: korrelatsiooniplot mudeli parameetritele.
</p>
</div>
<p>Normaaljaotus on selle poolest eriline, et tema parameetrid mu ja sigma ei ole korreleeritud. Paljud teised mudelid ei ole nii lahked. Siin on meil mõõdukas korrelatsioon nu ja sigma vahel. See on igati loogiline ja ei häiri meid.</p>
</div>
<div id="mcmc-ahelate-kvaliteet" class="section level3">
<h3><span class="header-section-number">8.0.3</span> MCMC ahelate kvaliteet</h3>
<p>Kui Rhat on 1, siis see tähendab, et MCMC ahelad on ilusti jooksnud ja posteeriori sämplinud. Kui Rhat &gt; 1.1, siis on kuri karjas. Suur Rhat viitab, et ahel(ad) pole jõudnud konvergeeruda. Kui ahelad ei konvergeeru, siis võib karta, et nad ei sämpli ka sama posteeriori jaotust. Kontrolli, kas mudeli kood ei sisalda vigu. Kui ei, siis vahest aitab, kui pikendada warm-up perioodi (map2stan(…, iter= 3000, warmup=2000) pikendab warm-upi 2 korda). Vahest aitab mudeli re-parametriseerimine (siin on lihtne trikk tekitada priorid, mis ei erineks väga palju oma vahemiku poolest; sellega kaasneb sageli andmete tsentreerimine või standardiseerimine; vt allpool).</p>
<p>n_eff on efektiivne valimi suurus, mis hindab iseseisvalt sämplitud andmete arvu ning see ei tohi olla väga väike. Kui n_eff on palju väiksem kui jooksutatud markovi ahela pikkus (iga ahel on defaultina 1000 iteratsiooni pikk), on ahel jooksnud ebaefektiivselt. See ei tähenda tingimata, et posteerior vale oleks. Reegilina peaks Neff/N &gt; 0.1</p>
<p>Ahelad peavad plotitud kujul välja nägema nagu karvased tõugud, mis on ilma paljaste laikudeta. Kui ahelad omavad pikki sirgeid lõike (n_eff tuleb siis väga madal), kus ahel ei ole töötanud, siis see rikub korralikult posteeriori. Tüüpiliselt aitavad nõrgalt informatiivsed priorid — priorite õige valik on sama palju arvutuslik vajadus kui taustainfo lisamine. Igal juhul tuleb vältida aladefineeritud tasaseid prioreid, mis võimaldavad ahelatel sämplida lõpmatust ja sel viisil õige tee kaotada. Peale selle, tasased priorid, mis ütlevad, et kõik parameetri väärtused on võrdselt tõenäolised, kajastavad harva meie tegelikke taustateadmisi.</p>
<p>halvad WARNING-ud: divergent transitions (too many), BMFI too low — võivad tähendada, et ahelad ei tööta korralikult. WARNING-ute kohta saad abi siit <a href="http://mc-stan.org/misc/warnings.html" class="uri">http://mc-stan.org/misc/warnings.html</a>.</p>
<p>Ilusamad parameetriplotid saab kasutades “bayesplot” raamatukogu funktsioone.</p>
<p>Esiteks usalduspiirid:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(bayesplot)
fit2d &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(m2<span class="op">@</span>stanfit)
pars &lt;-<span class="st"> </span><span class="kw">names</span>(fit2d)

<span class="co"># inner interval = 50% CI and outer interval = 95% CI.</span>
<span class="kw">mcmc_intervals</span>(fit2d, 
               <span class="dt">pars =</span> pars[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>], 
               <span class="dt">prob =</span> <span class="fl">0.5</span>, 
               <span class="dt">prob_outer =</span> <span class="fl">0.90</span>)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-118"></span>
<img src="main_files/figure-html/unnamed-chunk-118-1.pdf" alt="Posteeriorite CI plot" width="384" />
<p class="caption">
Joonis 8.6: Posteeriorite CI plot
</p>
</div>
<p>Ja teiseks täis posteeriorid.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mcmc_areas</span>(fit2d, <span class="dt">pars =</span> pars[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>], <span class="dt">prob =</span> <span class="fl">0.8</span>)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-119"></span>
<img src="main_files/figure-html/unnamed-chunk-119-1.pdf" alt="Posteeriorite tihedusplot." width="384" />
<p class="caption">
Joonis 8.7: Posteeriorite tihedusplot.
</p>
</div>
<p>Funktsiooniga <code>rethinking::extract.samples()</code> saame koos sämplitud parameetrite numbrid kõrvuti (rea kaupa) tabelisse.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m2sampl &lt;-<span class="st"> </span><span class="kw">extract.samples</span>(m2) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">CV =</span> sigma <span class="op">/</span><span class="st"> </span>mu)</code></pre></div>
<p>Sellest tabelist võib arvutada posteerioreid ka uutele “väljamõeldud” parameetritele. Näiteks arvutame posteeriori CV-le:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(m2sampl, <span class="kw">aes</span>(CV)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">by =</span> <span class="fl">0.1</span>)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">xlim</span>(<span class="dv">0</span>, <span class="dv">10</span>)</code></pre></div>
<pre><code>## Warning: Ignoring unknown parameters: breaks</code></pre>
<pre><code>## Warning: Removed 609 rows containing non-finite values
## (stat_density).</code></pre>
<div class="figure"><span id="fig:unnamed-chunk-121"></span>
<img src="main_files/figure-html/unnamed-chunk-121-1.pdf" alt="Posteerior uuele parameetrile" width="288" />
<p class="caption">
Joonis 8.8: Posteerior uuele parameetrile
</p>
</div>
<p>Kuna posteerior iseloomustab meie teadmiste piire, siis võime selle abil küsida, kui suure tõenäosusega jääb tõeline CV näiteks parameetrivahemikku 2 kuni 5?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">intv &lt;-<span class="st"> </span><span class="kw">filter</span>(m2sampl, <span class="kw">between</span>(CV, <span class="dv">2</span>, <span class="dv">5</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nrow</span>(.) <span class="op">/</span><span class="st"> </span><span class="kw">nrow</span>(m2sampl)
intv</code></pre></div>
<pre><code>## [1] 0.415</code></pre>
<p>Vastus on, et me arvame 42 kindlusega, et tõde jääb kuskile sellesse vahemikku.</p>
<p>Võime ka küsida, millesesse vahemikku jääb näiteks 67% meie usust mu tõelise väärtuse kohta?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">HPDI</span>(m2sampl<span class="op">$</span>CV, <span class="dt">prob =</span> <span class="fl">0.67</span>)</code></pre></div>
<pre><code>##  |0.67  0.67| 
## 0.9639 4.0580</code></pre>
<p>Nüüd võrdleme nelja fititud mudelit, et otsustada, milline mudel kirjeldab kõige paremini outlieritega andmeid. m0 on ilma outlierita mudel ja me tahame teada, milline mudel m1, m2 või m3 annab sellele kõige lähedasemad tulemused.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">coeftab_plot</span>(<span class="kw">coeftab</span>(m0, m1, m2, m3), 
             <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;mu&quot;</span>, <span class="st">&quot;sigma&quot;</span>), 
             <span class="dt">prob =</span> <span class="fl">0.5</span>)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-124"></span>
<img src="main_files/figure-html/unnamed-chunk-124-1.pdf" alt="V&lt;U+00F5&gt;rdlev plot mitme mudeli posteerioritele." width="384" />
<p class="caption">
Joonis 8.9: V<U+00F5>rdlev plot mitme mudeli posteerioritele.
</p>
</div>
<p>Me sättisime usalduspiirid 0.5 peale, mis tähendab, et need ennustavad, kuhu peaks mudeli järgi jääma parameetri tegelik väärtus 50%-se tõenäosusega. Nagu näha, on m2 ja m3 posteeriorid palju lähemal m0-le kui normaaljaotusega fititud m1 oma. Eriti drastilised on erinevused sigma hinnangule. Lisaks, m1 mudeli mu usaldusintervall on palju laiem kui m0, m2 ja m3 oma — mudel nagu saaks aru, et andmed lõhnavad kala järgi.</p>
</div>
<div id="naide-usa-presidentide-keskmine-pikkus" class="section level3">
<h3><span class="header-section-number">8.0.4</span> Näide: USA presidentide keskmine pikkus</h3>
<p>Läheme tagasi normaaljatuse ja USA presidentide juurde. Kõigepealt defineerime priorid. Alati on mõistlik priorid välja joonistada ja vaadata, kas nad vastavad meie ootustele. Pea meeles, et sigma ehk sd on samades ühikutes, mis mõõtmisandmed.</p>
<p>Kui sulle need priorid ei meeldi, tuuni priorite parameetreid ja proovi uuesti plottida.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="op">-</span><span class="dv">500</span><span class="op">:</span><span class="dv">500</span>
y &lt;-<span class="st"> </span><span class="kw">dnorm</span>(x, <span class="dv">0</span>, <span class="dv">200</span>)
<span class="kw">plot</span>(x, y, <span class="dt">main =</span> <span class="st">&quot;Prior for mu&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;l&quot;</span>)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-125"></span>
<img src="main_files/figure-html/unnamed-chunk-125-1.pdf" alt="Prior keskmisele." width="288" />
<p class="caption">
Joonis 8.10: Prior keskmisele.
</p>
</div>
<p>Siin kasutame nõrgalt informatiivseid prioreid. Idee on selles, et normaaljaotus, mis on tsentreeritud 0 ümber, tõmbab meie posteeriorit nõrgalt nulli poole (nõrgalt, sest jaotus on hästi lai võrreldes tõepärafunktsiooniga). Pane tähele, et oma priori kohaselt usume me, et 50% tõenäususega on USA presidentide keskmine pikkus negatiivne. See prior on tehniline abivahend, mitte meie tegelike uskumuste peegeldus presidentide kohta. Aga tehniliselt kõik töötab selles mõttes, et andmed domineerivad posteeriori üle ja priori sisuliselt ainus ülesanne on veidi MCMC mootori tööd lihtsustada.</p>
<p>Sigma priorina kasutame half-Cauchy jaotust, mis on samuti väheinformatiivne. Half-Cauchy ei saa olla &lt; 0 ja on meile soodsa kujuga sest annab suurema tõenäosuse nullile lähemal asuvatele sd-väärtustele — aga samas, kuna ta on paksu sabaga, ei välista see ka päris suuri sd väärtusi.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="dv">0</span><span class="op">:</span><span class="dv">200</span>
y &lt;-<span class="st"> </span><span class="kw">dcauchy</span>(x , <span class="dv">0</span>, <span class="dv">10</span>)
<span class="kw">plot</span>(x, y, <span class="dt">main =</span> <span class="st">&quot;Prior for sigma&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;l&quot;</span>)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-126"></span>
<img src="main_files/figure-html/unnamed-chunk-126-1.pdf" alt="Prior SD-le" width="288" />
<p class="caption">
Joonis 8.11: Prior SD-le
</p>
</div>
<p>Tekitame andmeraami analüüsiks ja mudeli, mis põhineb normaalsel tõepärafunktsioonil.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">heights &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">183</span>, <span class="dv">192</span>, <span class="dv">182</span>, <span class="dv">183</span>, <span class="dv">177</span>, <span class="dv">185</span>, <span class="dv">188</span>, <span class="dv">188</span>, <span class="dv">182</span>, <span class="dv">185</span>)
us_presidents &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Height =</span> heights, <span class="dt">id =</span> <span class="st">&quot;usa&quot;</span>)
potusm1 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(
  <span class="kw">alist</span>(
    Height <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(mu, sigma), <span class="co"># normal likelihood</span>
    mu <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, <span class="dv">200</span>), <span class="co"># normal prior for mean</span>
    sigma <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>, <span class="dv">10</span>) <span class="co"># half-cauchy prior from sd </span>
  ), <span class="dt">data =</span> us_presidents
)</code></pre></div>
<p>Mudeli koefitsiendid:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">precis</span>(potusm1)</code></pre></div>
<pre><code>##        Mean StdDev lower 0.89 upper 0.89 n_eff Rhat
## mu    184.5    1.5     181.90     186.71   482    1
## sigma   4.7    1.3       2.87       6.36   471    1</code></pre>
<p>Nüüd teeme katse võrrelda USA presidentide ja Euroopa ning mujalt pärit riigijuhtide keskmisi pikkusi. Kõigepealt loome analüüsitava andmeraami.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">world_leaders &lt;-<span class="st"> </span><span class="kw">read.csv2</span>(<span class="st">&quot;data/world_leaders.csv&quot;</span>)
presidents &lt;-<span class="st"> </span>world_leaders <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Country, Height) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">bind_rows</span>(us_presidents)</code></pre></div>
<pre><code>## Warning in bind_rows_(x, .id): Unequal factor levels:
## coercing to character</code></pre>
<pre><code>## Warning in bind_rows_(x, .id): binding character and
## factor vector, coercing into character vector

## Warning in bind_rows_(x, .id): binding character and
## factor vector, coercing into character vector</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">head</span>(presidents))</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">Country</th>
<th align="right">Height</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Canada</td>
<td align="right">188</td>
</tr>
<tr class="even">
<td align="left">Cuba</td>
<td align="right">190</td>
</tr>
<tr class="odd">
<td align="left">France</td>
<td align="right">170</td>
</tr>
<tr class="even">
<td align="left">France</td>
<td align="right">165</td>
</tr>
<tr class="odd">
<td align="left">France</td>
<td align="right">189</td>
</tr>
<tr class="even">
<td align="left">France</td>
<td align="right">172</td>
</tr>
</tbody>
</table>
<p>Ja siin on mudel. Nüüd on mu ümber defineeritud kui mu1[indeks], mis tähendab, et mu1 saab kaks hulka väärtusi, üks kummagil indeks muutuja tasemel. Sellega jagame oma andmed kahte ossa (USA versus Euroopa ja muu maailm), mida analüüsime eraldi. Sigma on mõlemale kontinendile sama, mis tähendab, et mudel eeldab, et presidentide pikkuste jaotus on mõlemal kontinendil identne.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Split into 2 groups</span>
presidents &lt;-<span class="st"> </span>presidents <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Groups =</span> <span class="kw">case_when</span>(
    Country <span class="op">==</span><span class="st"> &quot;USA&quot;</span> <span class="op">~</span><span class="st"> &quot;USA&quot;</span>,
    Country <span class="op">!=</span><span class="st"> &quot;USA&quot;</span> <span class="op">~</span><span class="st"> &quot;World&quot;</span>
  ))</code></pre></div>
<p>Adult human height varies country-by-country, we take 170 cm as relatively safe prior for male height.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">potusm2 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(
  <span class="kw">alist</span>(
    Height <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(mu, sigma),
    mu &lt;-<span class="st"> </span>mu_<span class="dv">1</span>[Groups], <span class="co"># mu is redifined as mu_1, which takes values at each indeks level</span>
    mu_<span class="dv">1</span>[Groups] <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">170</span>, <span class="dv">10</span>), <span class="co"># normal prior for mean</span>
    sigma <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>, <span class="dv">10</span>) <span class="co"># half-cauchy prior from sd </span>
  ),
  <span class="dt">data =</span> presidents)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">precis</span>(potusm2, <span class="dt">depth =</span> <span class="dv">2</span>)</code></pre></div>
<pre><code>##           Mean StdDev lower 0.89 upper 0.89 n_eff Rhat
## mu_1[1] 182.75   3.57     177.11     188.25   885    1
## mu_1[2] 176.30   1.85     173.33     179.15   836    1
## sigma    11.65   1.26       9.86      13.77   628    1</code></pre>
<p>Me võime ka vaadata 2 grupi standardhälbeid lahus. Järgnevas mudelis on mõistlik ahelale stardipositsioon ette anda.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Calculate start values
startvalues &lt;-<span class="st"> </span>presidents <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(Groups) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise_at</span>(<span class="kw">vars</span>(Height), <span class="kw">funs</span>(mean, sd))
## Fit model
potusm2.<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">map2stan</span>(
  <span class="kw">alist</span>(
    Height <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(mu, sigma),
    mu &lt;-<span class="st"> </span>mu_<span class="dv">1</span>[Groups],
    sigma &lt;-<span class="st"> </span>sigma_<span class="dv">1</span>[Groups],
    mu_<span class="dv">1</span>[Groups] <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">170</span>, <span class="dv">10</span>), <span class="co"># normal prior for mean</span>
    sigma_<span class="dv">1</span>[Groups] <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>, <span class="dv">10</span>) <span class="co"># half-cauchy prior from sd </span>
  ),
  <span class="dt">data =</span> presidents, 
  <span class="dt">start =</span> <span class="kw">list</span>(<span class="dt">mu_1 =</span> startvalues<span class="op">$</span>mean,
               <span class="dt">sigma_1 =</span> startvalues<span class="op">$</span>sd)
)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tracerplot</span>(potusm2.<span class="dv">1</span>, <span class="dt">n_cols =</span> <span class="dv">2</span>)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-137"></span>
<img src="main_files/figure-html/unnamed-chunk-137-1.pdf" alt="Traceplot." width="384" />
<p class="caption">
Joonis 8.12: Traceplot.
</p>
</div>
<p>Tulemus ES-i osas tuleb üsna sarnane.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="kw">coeftab</span>(potusm2, potusm2.<span class="dv">1</span>))</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-138"></span>
<img src="main_files/figure-html/unnamed-chunk-138-1.pdf" alt="mudelite v&lt;U+00F5&gt;rdlusplot." width="384" />
<p class="caption">
Joonis 8.13: mudelite v<U+00F5>rdlusplot.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">precis</span>(potusm2, <span class="dt">depth =</span> <span class="dv">2</span>)</code></pre></div>
<pre><code>##           Mean StdDev lower 0.89 upper 0.89 n_eff Rhat
## mu_1[1] 182.75   3.57     177.11     188.25   885    1
## mu_1[2] 176.30   1.85     173.33     179.15   836    1
## sigma    11.65   1.26       9.86      13.77   628    1</code></pre>
<p>Siin tuleb kasulik trikk: me lahutame rea kaupa mu1[1] posteeriori sampli liikmed mu1[2] sampli liikmetest. Nii saame posteeriori efekti suurusele ehk hinnangu sellele, mitme cm võrra on USA presidendid keskmiselt pikemad kui Euroopa omad!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">samplespm2 &lt;-<span class="st"> </span><span class="kw">extract.samples</span>(potusm2) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ES =</span> mu_<span class="fl">1.1</span> <span class="op">-</span><span class="st"> </span>mu_<span class="fl">1.2</span>)
<span class="kw">dens</span>(samplespm2<span class="op">$</span>ES)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-140"></span>
<img src="main_files/figure-html/unnamed-chunk-140-1.pdf" alt="Posteerior ES-le." width="288" />
<p class="caption">
Joonis 8.14: Posteerior ES-le.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Mean ES
<span class="kw">median</span>(samplespm2<span class="op">$</span>ES)</code></pre></div>
<pre><code>## [1] 6.556</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## 90% HDI
<span class="kw">HPDI</span>(samplespm2<span class="op">$</span>ES, <span class="dt">prob =</span> <span class="fl">0.9</span>)</code></pre></div>
<pre><code>##   |0.9   0.9| 
## -1.089 12.018</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Probability of ES being smaller than 0
<span class="kw">mean</span>(samplespm2<span class="op">$</span>ES <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>)</code></pre></div>
<pre><code>## [1] 0.065</code></pre>
<p>Võrdse SD-ga mudeli järgi on USA presidendid keskeltläbi 6.6 cm pikemad, ebakindlus selle hinnangu ümber on suur – 90% HDI on -1.1 kuni 12 ja tõenäosus et pikkuste erinevus on väiksem kui 0 on 0.06.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">samplesm2.<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">extract.samples</span>(potusm2.<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ES =</span> mu_<span class="fl">1.1</span> <span class="op">-</span><span class="st"> </span>mu_<span class="fl">1.2</span>)
<span class="kw">median</span>(samplesm2.<span class="dv">1</span><span class="op">$</span>ES)</code></pre></div>
<pre><code>## [1] 7.541</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">HPDI</span>(samplesm2.<span class="dv">1</span><span class="op">$</span>ES, <span class="dt">prob =</span> <span class="fl">0.9</span>)</code></pre></div>
<pre><code>##   |0.9   0.9| 
##  3.395 12.164</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(samplesm2.<span class="dv">1</span><span class="op">$</span>ES <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>)</code></pre></div>
<pre><code>## [1] 0.001</code></pre>
<p>Erineva SD-ga mudeli järgi on riigijuhtide pikkuste vahe 7.5 cm, ebakindlus väiksem – 90% HDI on 3.4 kuni 12.2 ja tõenäosus et pikkuste erinevus on väiksem kui 0 on 0.</p>
<p>See ei tähenda tingimata, et me peaksime eelistama teist mudelit. Oluline on, mida me teoreetiliselt usume, kas seda, et tegelik presidentide varieeruvus on USAs ja Euroopas võrdne, või mitte.</p>
</div>
</div>
<div id="lineaarne-regressioon" class="section level2">
<h2><span class="header-section-number">8.1</span> Lineaarne regressioon</h2>
<p>Eelmises peatükis hindasime ühe andmekogu (näiteks mõõdetud pikkuste) põhjal ehitatud mudelite parameetreid (näiteks keskmist ja statndardhälvet). Nüüd astume sammu edasi ja hindame kahe muutuja (näiteks pikkuse ja kaalu) koos-varieeruvust. Selleks ehitame mudeli, mis sisaldab mõlemaid muutujaid ja küsime: kui palju sõltub y varieeruvus x varieeruvusest. Lihtsaim viis sellele küsimusele läheneda on lineaarse regressiooni kaudu. Me ehitame lineaarse mudeli, mis vaatab kaalu-pikkuse paare (igal subjektil mõõdeti kaal ja pikkus ning mudel vaatab kaalu ja pikkuse koos-varieeruvust subjektide vahel). Enam ei tohiks tulla üllatusena, et meie arvutused ei anna numbrilist hinnangut mitte teaduslikule küsimusele selle kohta kuidas <em>y</em>-i väärtused sõltuvad <em>x</em>-i väärtustest, vaid mudeli parameetritele. Meie mudel on sirge võrrand <span class="math inline">\(y = a + b*x\)</span> ja tavapärases R-i notatsioonis kirjutatakse see <em>y~x</em>.</p>
<p>Kuna pikkused ja kaalud on igavad, proovime vaadata kuidas riigi keskmine eluiga on seotud riigi rikkusega.</p>
</div>
<div id="lm---vahimruutude-meetodiga-fititud-lineaarsed-mudelid" class="section level2">
<h2><span class="header-section-number">8.2</span> <code>lm()</code> - vähimruutude meetodiga fititud lineaarsed mudelid</h2>
<p>Kautame gapminder andmeid aastast 2007.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Select only data from year 2007</span>
g2007 &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2007</span>)
knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">head</span>(g2007))</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">country</th>
<th align="left">continent</th>
<th align="right">year</th>
<th align="right">lifeExp</th>
<th align="right">pop</th>
<th align="right">gdpPercap</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="left">Asia</td>
<td align="right">2007</td>
<td align="right">43.83</td>
<td align="right">31889923</td>
<td align="right">974.6</td>
</tr>
<tr class="even">
<td align="left">Albania</td>
<td align="left">Europe</td>
<td align="right">2007</td>
<td align="right">76.42</td>
<td align="right">3600523</td>
<td align="right">5937.0</td>
</tr>
<tr class="odd">
<td align="left">Algeria</td>
<td align="left">Africa</td>
<td align="right">2007</td>
<td align="right">72.30</td>
<td align="right">33333216</td>
<td align="right">6223.4</td>
</tr>
<tr class="even">
<td align="left">Angola</td>
<td align="left">Africa</td>
<td align="right">2007</td>
<td align="right">42.73</td>
<td align="right">12420476</td>
<td align="right">4797.2</td>
</tr>
<tr class="odd">
<td align="left">Argentina</td>
<td align="left">Americas</td>
<td align="right">2007</td>
<td align="right">75.32</td>
<td align="right">40301927</td>
<td align="right">12779.4</td>
</tr>
<tr class="even">
<td align="left">Australia</td>
<td align="left">Oceania</td>
<td align="right">2007</td>
<td align="right">81.23</td>
<td align="right">20434176</td>
<td align="right">34435.4</td>
</tr>
</tbody>
</table>
<p>Enne kui SKP ja eluea seoseid otsima hakkame, vaatame, mis juhtub, kui me arvutame ainult interceptiga mudeli, kus puudub SKP (kasutades lihtsuse mõttes mudeli fittimiseks nn vähimruutude meetodit <code>lm()</code> funktsiooni abil).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapmod1 &lt;-<span class="st"> </span><span class="kw">lm</span>(lifeExp <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">data =</span> g2007)
<span class="kw">summary</span>(gapmod1)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = lifeExp ~ 1, data = g2007)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -27.39  -9.85   4.93   9.41  15.60 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)    67.01       1.01    66.1   &lt;2e-16 ***
## ---
## Signif. codes:  
## 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 12.1 on 141 degrees of freedom</code></pre>
<p>Ok, intercept = 67. Mida see tähendab?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(g2007<span class="op">$</span>lifeExp)</code></pre></div>
<pre><code>## [1] 67.01</code></pre>
<p>See on lihtsalt parameetri, mida me ennustame, keskmine väärtus ehk keskmine eluiga üle kõikide riikide.</p>
<p>Nüüd fitime mudeli, kus on olemas SKP ja eluea seos aga puudub lõikepunkt.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapmod2 &lt;-<span class="st"> </span><span class="kw">lm</span>(lifeExp <span class="op">~</span><span class="st"> </span><span class="op">-</span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>gdpPercap, <span class="dt">data =</span> g2007)
<span class="kw">summary</span>(gapmod2)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = lifeExp ~ -1 + gdpPercap, data = g2007)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
##  -65.5   17.6   44.9   54.7   67.0 
## 
## Coefficients:
##           Estimate Std. Error t value Pr(&gt;|t|)    
## gdpPercap 0.002951   0.000218    13.5   &lt;2e-16 ***
## ---
## Signif. codes:  
## 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 45.1 on 141 degrees of freedom
## Multiple R-squared:  0.565,  Adjusted R-squared:  0.562 
## F-statistic:  183 on 1 and 141 DF,  p-value: &lt;2e-16</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(g2007<span class="op">$</span>gdpPercap, g2007<span class="op">$</span>lifeExp, <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(g2007<span class="op">$</span>lifeExp)))
<span class="kw">abline</span>(gapmod2)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-147"></span>
<img src="main_files/figure-html/unnamed-chunk-147-1.pdf" alt="Nulli surutud interceptiga lineaarne regressioon eluea s&lt;U+00F5&gt;ltuvusele SKP-st." width="384" />
<p class="caption">
Joonis 8.15: Nulli surutud interceptiga lineaarne regressioon eluea s<U+00F5>ltuvusele SKP-st.
</p>
</div>
<p>Nüüd on intercept surutud väärtusele y = 0.</p>
<p>Ja lõpuks täismudel</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapmod3 &lt;-<span class="st"> </span><span class="kw">lm</span>(lifeExp <span class="op">~</span><span class="st"> </span>gdpPercap, <span class="dt">data =</span> g2007)
<span class="kw">summary</span>(gapmod3)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = lifeExp ~ gdpPercap, data = g2007)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -22.83  -6.32   1.92   6.90  13.13 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) 5.96e+01   1.01e+00    59.0   &lt;2e-16 ***
## gdpPercap   6.37e-04   5.83e-05    10.9   &lt;2e-16 ***
## ---
## Signif. codes:  
## 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 8.9 on 140 degrees of freedom
## Multiple R-squared:  0.461,  Adjusted R-squared:  0.457 
## F-statistic:  120 on 1 and 140 DF,  p-value: &lt;2e-16</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(g2007<span class="op">$</span>gdpPercap, g2007<span class="op">$</span>lifeExp, <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(g2007<span class="op">$</span>lifeExp)))
<span class="kw">abline</span>(gapmod2)
<span class="kw">abline</span>(gapmod3, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-149"></span>
<img src="main_files/figure-html/unnamed-chunk-149-1.pdf" alt="T&lt;U+00E4&gt;ismudeliga regressioon." width="384" />
<p class="caption">
Joonis 8.16: T<U+00E4>ismudeliga regressioon.
</p>
</div>
<p>Kuidas me seda m3 mudelit tõlgendame? Esiteks, Intercept on 59.6, mis tähendab, et mudel ennustab, et kui riigi SKP = 0 USD, siis selle riigi elanime keskmine euliga on ligi 60 aastat. See on selgelt imelik, sest ühegi riigi SKP ei ole null, ja kui oleks, oleks seal ka eluiga 0 (selle järgi peaksime eelistama mudelit gapmod2, kus me oleme intercepti nulli surunud).</p>
<p>Teiseks, koefitsient b = 0.00064, mis on üsna väike arv. See tähendab, et SKP tõus 1 USD võrra tõstab eluiga keskmiselt 0.00064 aasta võrra (ja SKP tõus 1000 USD võrra tõstab eluiga 0.64 aasta võrra). Muidugi ainult siis, kui uskuda mudelit.</p>
<p>Kolmandaks, adjusted R squared on 0.46, mis tähendab et mudeli järgi seletab SKP varieerumine 46% eluea varieeruvusest riikide vahel.</p>
<p>Hea küll, aga milline mudel on siis parim?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">AIC</span>(gapmod1, gapmod2, gapmod3))</code></pre></div>
<table>
<thead>
<tr class="header">
<th></th>
<th align="right">df</th>
<th align="right">AIC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>gapmod1</td>
<td align="right">2</td>
<td align="right">1113</td>
</tr>
<tr class="even">
<td>gapmod2</td>
<td align="right">2</td>
<td align="right">1487</td>
</tr>
<tr class="odd">
<td>gapmod3</td>
<td align="right">3</td>
<td align="right">1028</td>
</tr>
</tbody>
</table>
<p>AIC on <em>Aikake informatsiooni kriteerium</em>, mis võtab arvesse nii mudeli fiti headuse kui mudeli parameetrite arvu. Kuna R saab parameetreid lisades ainult kasvada ja me teame, et mingist hetkest oleme niikuinii oma mudeli üle fittinud, siis otsime AIC-i abil kompromissi: võimalult hea fit võimalikult väikese parameetrite arvuga. AIC on suhteline mõõt, selle absoluutnäit ei oma mingit tähendust. Me eelistame väiksema AIC-ga mudelit nende mudelite seast, mida me võrdleme. See ei tähenda, et võitnud mudel oleks hea mudel — alati on võimalik, et kõik head mudelid jäid võrdlusest välja.</p>
<p>Seega parim mudel on gapmod3 ja kõige kehvem on gapmod2, mille lõikepunkt on realistlikult nulli fikseeritud!</p>
</div>
<div id="bayesi-meetodil-lineaarse-mudeli-fittimine" class="section level2">
<h2><span class="header-section-number">8.3</span> Bayesi meetodil lineaarse mudeli fittimine</h2>
<p>Nüüd Bayesi mudelid. “rethinking” paketi <code>glimmer()</code> on abivahend, mis konverteerib <code>lm()</code> mudeli kirjelduse Bayesi mudeli kirjelduseks kasutades normaaljaotusega tõepära mudelit. Intercept only model</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">intercept_only &lt;-<span class="st"> </span><span class="kw">glimmer</span>(lifeExp <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">data =</span> g2007)</code></pre></div>
<pre><code>## alist(
##     lifeExp ~ dnorm( mu , sigma ),
##     mu &lt;- Intercept,
##     Intercept ~ dnorm(0,10),
##     sigma ~ dcauchy(0,2)
## )</code></pre>
<p>Ainult interceptiga mudel. Keskväärtus ehk mu on ümber defineeritud kui intercept, aga see annab talle lihtsalt uue nime. Sama hästi oleksime võinud fittida mudelit, kus hindame otse mu keskväärtust (nagu me eelmises peatükis tegime). Pane tähele, et võrreldes <code>lm()</code> funktsiooniga on meil mudelis lisaparameeter — sigma. Kui Intercept annab meile keskmise eluea, siis sigma annab eluigade standardhälbe riikide vahel.</p>
<blockquote>
<p>Kui me tahame fittida lineaarset mudelit, siis peab tõepära funktsioon olema kas normaaljaotus või studenti t jaotus.</p>
</blockquote>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapmod4 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(<span class="dt">flist =</span> intercept_only<span class="op">$</span>f, <span class="dt">data =</span> intercept_only<span class="op">$</span>d)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">precis</span>(gapmod4)</code></pre></div>
<pre><code>##            Mean StdDev lower 0.89 upper 0.89 n_eff
## Intercept 66.26   0.99      64.57       67.8   694
## sigma     12.11   0.71      10.97       13.2   554
##           Rhat
## Intercept    1
## sigma        1</code></pre>
<p>Nüüd ilma interceptita mudel</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">no_intercept &lt;-<span class="st"> </span><span class="kw">glimmer</span>(lifeExp <span class="op">~</span><span class="st"> </span><span class="op">-</span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>gdpPercap, <span class="dt">data =</span> g2007)</code></pre></div>
<pre><code>## alist(
##     lifeExp ~ dnorm( mu , sigma ),
##     mu &lt;- b_gdpPercap*gdpPercap,
##     b_gdpPercap ~ dnorm(0,10),
##     sigma ~ dcauchy(0,2)
## )</code></pre>
<p>Selline Bayesi mudeli esitus on “ilusam” kui <code>lm()</code> sest ta toob mudeli eksplitsiitselt välja (samas kui lm notatsioon ütleb, et mudel on “miinus intercept”)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapmod5 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(<span class="dt">flist =</span> no_intercept<span class="op">$</span>f, <span class="dt">data =</span> no_intercept<span class="op">$</span>d)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">precis</span>(gapmod5)</code></pre></div>
<pre><code>##              Mean StdDev lower 0.89 upper 0.89 n_eff
## b_gdpPercap  0.00   0.00       0.00       0.00   888
## sigma       45.25   2.75      40.82      49.41   187
##             Rhat
## b_gdpPercap    1
## sigma          1</code></pre>
<p>Ja lõpuks täismudel:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">full_model &lt;-<span class="st"> </span><span class="kw">glimmer</span>(lifeExp <span class="op">~</span><span class="st"> </span>gdpPercap, <span class="dt">data =</span> g2007)</code></pre></div>
<pre><code>## alist(
##     lifeExp ~ dnorm( mu , sigma ),
##     mu &lt;- Intercept +
##         b_gdpPercap*gdpPercap,
##     Intercept ~ dnorm(0,10),
##     b_gdpPercap ~ dnorm(0,10),
##     sigma ~ dcauchy(0,2)
## )</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapmod6 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(<span class="dt">flist =</span> full_model<span class="op">$</span>f, <span class="dt">data =</span> full_model<span class="op">$</span>d)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">compare</span>(gapmod4, gapmod5, gapmod6)</code></pre></div>
<pre><code>##         WAIC pWAIC dWAIC weight    SE   dSE
## gapmod6 1028   2.6   0.0      1 14.07    NA
## gapmod4 1113   1.5  85.7      0 12.09  9.67
## gapmod5 1486   0.8 458.8      0  7.29 15.70</code></pre>
<p>Jälle on täismudel võitja ja kui intercept nulli suruda, saame kehveima tulemuse. Siin me kasutame AIC-i Bayesi analoogi WAIC, mis nende mudelite peal peaks töötama veidi paremini kui AIC. Aga see on tehniline detail. WAIC abil mudeleid võrreldes saame muuhulgas mudeli kaalu. Antud juhul on 100% kaalust gapmo6-l ja ülejäänud mudelitele ei jää midagi.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="kw">coeftab</span>(gapmod4, gapmod5, gapmod6))</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-164"></span>
<img src="main_files/figure-html/unnamed-chunk-164-1.pdf" alt="Mudelite v&lt;U+00F5&gt;rdlusplot." width="384" />
<p class="caption">
Joonis 8.17: Mudelite v<U+00F5>rdlusplot.
</p>
</div>
<p>Viime SKP andmed log-skaalasse ja proovime uuesti. See tähendab, et me arvame, et iga SKP kümnekordne tõus võiks kaasa tuua eluea tõusu x aasta võrra.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">g2007 &lt;-<span class="st"> </span>g2007 <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">l_GDP =</span> <span class="kw">log10</span>(gdpPercap))
<span class="co"># glimmer(lifeExp ~ -1 + l_GDP, data = g2007)</span>
gapmod7 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(<span class="kw">alist</span>(
    lifeExp <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(mu, sigma),
    mu &lt;-<span class="st"> </span>b_gdp <span class="op">*</span><span class="st"> </span>l_GDP,
    b_gdp <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, <span class="dv">10</span>),
    sigma <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>, <span class="dv">2</span>)
), <span class="dt">data =</span> g2007)

gapmod8 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(<span class="kw">alist</span>(
    lifeExp <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(mu, sigma),
    mu &lt;-<span class="st"> </span>Intercept <span class="op">+</span><span class="st"> </span>b_gdp <span class="op">*</span><span class="st"> </span>l_GDP,
    Intercept <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, <span class="dv">100</span>),
    b_gdp <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, <span class="dv">10</span>),
    sigma <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>, <span class="dv">2</span>)
), <span class="dt">data =</span> g2007)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">compare</span>(gapmod4, gapmod5, gapmod6, gapmod7, gapmod8)</code></pre></div>
<pre><code>##           WAIC pWAIC dWAIC weight    SE   dSE
## gapmod7  965.3   3.0   0.0   0.53 25.11    NA
## gapmod8  965.5   3.8   0.2   0.47 25.37  2.56
## gapmod6 1027.6   2.6  62.4   0.00 14.07 18.21
## gapmod4 1113.4   1.5 148.1   0.00 12.09 23.18
## gapmod5 1486.4   0.8 521.1   0.00  7.29 26.82</code></pre>
<div class="figure"><span id="fig:unnamed-chunk-168"></span>
<img src="main_files/figure-html/unnamed-chunk-168-1.pdf" alt="Log skaalas t&lt;U+00F6&gt;&lt;U+00F6&gt;tab nulli surutud interceptiga mudel sama h&lt;U+00E4&gt;sti kui t&lt;U+00E4&gt;ismudel. See ei ole paraku mudeldamise &lt;U+00FC&gt;ldine omadus." width="384" />
<p class="caption">
Joonis 8.18: Log skaalas t<U+00F6><U+00F6>tab nulli surutud interceptiga mudel sama h<U+00E4>sti kui t<U+00E4>ismudel. See ei ole paraku mudeldamise <U+00FC>ldine omadus.
</p>
</div>
<p>Kuna Bayesi mudelite fittimine on keerulisem kui <code>lm()</code> abil, on eriti tähtis fititud mudel välja plottida. See on esimene kaitseliin lollide vigade ja halvasti jooksvate Markovi ahelate vastu.</p>
<p>Kui Bayesi mudeleid on raskem fittida, siis milleks me peaksime neid eelistama tavalistele vähimruutude meetodil fititud mudelitele? Tegelikult alati ei peagi. Aga siiski, Bayesi mudelid sisaldavad eksplitsiitset veakomonenti (sigma), mis on kasulik mudelist uusi andmeid ennustades. Samuti annavad nad parima hinnangu ebakindlusele parmeetrite väärtuste hinnangute ümber, võimaldavad mudeli fittimisel siduda andmeid taustainfoga (prior) ning, mis kõige tähtsam, võimaldavad paindlikumalt fittida hierarhilisi mudeleid (nende juurde tuleme hiljem).</p>
<p>Samas, kui prior on väheinformatiivne, siis Bayesi hinnangud mudeli koefitsientide kõige tõenäolisematele väärtustele on praktiliselt samad, kui vähimruutude meetodiga <code>lm()</code> abil saadud punkt-hinnangud.</p>
<p>Siin me fitime pedagooglistel kaalutlustel kõike Bayesiga aga praktikas jätavad paljud mõistlikud inimesed Bayesi hierarhiliste mudelite jaoks ja kasutavad lihtsate mudelite jaoks <code>lm()</code>.</p>
<p>Tagasi gapmod7 ja gapmod8 mudelite juurde. Plotime nende koefitsiendid koos usalduspiiridega.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="kw">coeftab</span>(gapmod7, gapmod8))</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-169"></span>
<img src="main_files/figure-html/unnamed-chunk-169-1.pdf" alt="mudelite v&lt;U+00F5&gt;rdlusplot." width="384" />
<p class="caption">
Joonis 8.19: mudelite v<U+00F5>rdlusplot.
</p>
</div>
<p>Pane tähele, et gapmod8 “b_gdp” koefitsiendi posteerior on palju laiem kui gapmod7 “b_gdp” oma. See on üldine nähtus, mis tuleneb sellest, et gapmod7-s on vähem parameetreid. <strong>Iga lisatud parameeter kipub vähendama teiste parameetrite hindamise täpsust.</strong></p>
</div>
<div id="ennustused-mudelist" class="section level2">
<h2><span class="header-section-number">8.4</span> Ennustused mudelist</h2>
<p>Kuidas plottida meie hinnangud ebakindlusele parameetri tegeliku väärtuse ümber? Siin tuleb appi <code>rethinking::link()</code>.</p>
<p>Nii tõmbame posteriorist igale meie andmetes esinevale log GDP väärtusele vastavad 1000 ennustust keskmise eluea kohta sellel l_GDP väärtusel:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">linked &lt;-<span class="st"> </span><span class="kw">link</span>(gapmod8)
linked &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(linked)
linked_mean &lt;-<span class="st"> </span><span class="kw">apply</span>(linked, <span class="dv">2</span>, HPDI, <span class="dt">prob =</span> <span class="fl">0.95</span>)</code></pre></div>
<p>Sel viisil saab tabeli, kus igale 142-le andmepunktist vastab üks veerg, milles on 1000 posteeriorist arvutatud ennustust lifeExp väärtusele.</p>
<p>Praktikas soovime aga enamasti meie poolt ette antud l_GDP väärtustel põhinevaid ennustusi keskmise eluea kohta. See käib nii:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># first we create an evenly spced grid of l_GDP values, </span>
<span class="co"># for which we wish to obtain 95% CI-s </span>
width &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">2</span>, <span class="dv">6</span>, <span class="fl">0.1</span>)

<span class="co"># link() draws from the posterior 1000 mu values for each l_GDP value in the width object; out pops a table with 1000 rows and 41 columns. </span>
mu1 &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(<span class="kw">link</span>(gapmod8, <span class="dt">data =</span> <span class="kw">data.frame</span>(<span class="dt">l_GDP =</span> width)))</code></pre></div>
<pre><code>## [ 100 / 1000 ]
[ 200 / 1000 ]
[ 300 / 1000 ]
[ 400 / 1000 ]
[ 500 / 1000 ]
[ 600 / 1000 ]
[ 700 / 1000 ]
[ 800 / 1000 ]
[ 900 / 1000 ]
[ 1000 / 1000 ]</code></pre>
<p>Nüüd on meil mu1 objektis 41 l_GDP väärtust, millest igale vastab 1000 ennustust keskmise eluea kohta sellel l_GDP-l. Järgmiseks arvutame igale neist 41-st tulbast keskmise ja 95% HPDI ning plotime need koos andmepunktidega kasutades base-R graafikasüsteemi.</p>
<p>Pane tähele, et hall riba näitab ebakindlust ennustuse ümber keskmisele elueale üle kõikide riikide, mis võiksid sellist l_GDP-d omada (ehk ebakindlust regressioonijoonele). Kui me aga tahame ennustada ka keskmiste eluigade varieeruvust riigi tasemel (kasutades Bayesi hinnangut sigma parameetrile), siis on meil vaja <code>sim()</code> funktsiooni:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mu.mean &lt;-<span class="st"> </span><span class="kw">apply</span>(mu1, <span class="dv">2</span>, mean) <span class="co"># applies the FUN mean() to each column</span>
mu.HPDI &lt;-<span class="st"> </span><span class="kw">apply</span>(mu1, <span class="dv">2</span>, HPDI, <span class="dt">prob =</span> <span class="fl">0.95</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">t</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">as_data_frame</span>()
mu.HPDI &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(<span class="kw">data_frame</span>(width), mu.HPDI)
<span class="kw">colnames</span>(mu.HPDI) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;width&quot;</span>, <span class="st">&quot;lower&quot;</span>, <span class="st">&quot;upper&quot;</span>)
sim.length &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(rethinking<span class="op">::</span><span class="kw">sim</span>(gapmod8, <span class="dt">data =</span> <span class="kw">list</span>(<span class="dt">l_GDP =</span> width)))</code></pre></div>
<pre><code>## [ 100 / 1000 ]
[ 200 / 1000 ]
[ 300 / 1000 ]
[ 400 / 1000 ]
[ 500 / 1000 ]
[ 600 / 1000 ]
[ 700 / 1000 ]
[ 800 / 1000 ]
[ 900 / 1000 ]
[ 1000 / 1000 ]</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">height.PI &lt;-<span class="st"> </span><span class="kw">apply</span>(sim.length, <span class="dv">2</span>, PI, <span class="dt">prob =</span> <span class="fl">0.95</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">t</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">as_data_frame</span>()
height.PI &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(<span class="kw">data_frame</span>(width), height.PI)
<span class="kw">colnames</span>(height.PI) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;width&quot;</span>, <span class="st">&quot;lower&quot;</span>, <span class="st">&quot;upper&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(g2007) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(l_GDP, lifeExp, <span class="dt">color =</span> continent)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> <span class="kw">data_frame</span>(width, mu.mean), <span class="kw">aes</span>(width, mu.mean)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">data =</span> mu.HPDI, <span class="kw">aes</span>(<span class="dt">x =</span> width, <span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper), 
              <span class="dt">fill =</span> <span class="st">&quot;gray10&quot;</span>, <span class="dt">alpha =</span> <span class="fl">0.3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">data =</span> height.PI, <span class="kw">aes</span>(<span class="dt">x =</span> width, <span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper), 
              <span class="dt">fill =</span> <span class="st">&quot;gray40&quot;</span>, <span class="dt">alpha =</span> <span class="fl">0.3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">caption =</span> <span class="st">&quot;Dark grey, 95% HDPI - highest posterior density.</span><span class="ch">\n</span><span class="st">Light grey, 95% PI - percentile interval.&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.title =</span> <span class="kw">element_blank</span>())</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-173"></span>
<img src="main_files/figure-html/unnamed-chunk-173-1.pdf" alt="Ennustused mudelist." width="672" />
<p class="caption">
Joonis 8.20: Ennustused mudelist.
</p>
</div>
<p>Nüüd ütleb laiem hall ala, et me oleme üsna kindlad, et nende riikide puhul, mille puhul mudel töötab, kohtame individaalsete riikide keskmiseid eluigasid halli ala sees ja mitte sealt väljas. Nagu näha, on meil ka riike, mis jäävad hallist alast kaugele ja mille keskmine eluiga on kõvasti madalam, kui mudel ennustab. Need on äkki riigid, kus parasjagu on sõda üle käinud ja mille eluiga ei ole näiteks seetõttu SKP-ga lihtsas põhjuslikus seoses. Igal juhul tasuks need ükshaaval üle vaadata sest punktid, mida mudel ei seleta, võivad varjata endas mõnd huvitavat saladust, mis pikisilmi ootab avastajat. Lisaks: pane tähele, et mudel eeldab, et riikide keskmise eluea SD on muutumatu igal GDP väärtusel.</p>
<p>Kuidas saada ennustusi kindlale l_GDP väärtusele? Näiteks tulp V10 vastab l_GDP väärtusele 2.9. Järgnevalt arvutame oodatavad keskmised eluead sellele SKP väärtusele (fiksionaalsetele riikidele, millel võiks olla täpselt selline SKP):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dens</span>(sim.length<span class="op">$</span>V10)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-174"></span>
<img src="main_files/figure-html/unnamed-chunk-174-1.pdf" alt="Ennustus mudelist kindlale l_GDP v&lt;U+00E4&gt;&lt;U+00E4&gt;rtusele." width="288" />
<p class="caption">
Joonis 8.21: Ennustus mudelist kindlale l_GDP v<U+00E4><U+00E4>rtusele.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">HPDI</span>(sim.length<span class="op">$</span>V10, <span class="dt">prob =</span> <span class="fl">0.95</span>)</code></pre></div>
<pre><code>## |0.95 0.95| 
## 38.06 65.67</code></pre>
<p>Nagu näha, võib mudeli kohaselt sellise riigi keskmine eluiga tulla nii madal, kui 40 aastat ja nii kõrge kui 67 aastat.</p>
<div id="lognormaalne-toeparamudel" class="section level3">
<h3><span class="header-section-number">8.4.1</span> Lognormaalne tõepäramudel</h3>
<p>See mudel on alternatiiv andmete logaritmimisele, kui Y-muutuja (see muutuja, mille väärtust te ennustate) on lognormaalse jaotusega.</p>
<blockquote>
<p>Lognormaalne Y-i tõepäramudel on mittelineaarne. Lognormaaljaotus defineetitakse üle mu ja sigma, mis aga vastavd hoopis log(Y) normaaljaotuse mu-le ja sigmale.</p>
</blockquote>
<p>Seekord ennustame GDP-d keskmise eluea põhjal (mis, nagu näha jooniselt, ei ole küll päris lognormaalne).</p>
<div class="figure"><span id="fig:unnamed-chunk-175"></span>
<img src="main_files/figure-html/unnamed-chunk-175-1.pdf" alt="SKP-de jaotus" width="384" />
<p class="caption">
Joonis 8.22: SKP-de jaotus
</p>
</div>
<p>Mustaga on näidatud empiiriline SKP jaotus, punasega fititud lognormaalne mudel sellest samast jaotusest. Järgnevalt ennustame SKP-d keskmise eluea põhjal, milleks fitime lognormaalse tõepäramudeli, kus mu on ümber defineeritud regressioonivõrrandiga:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m_ln1 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(
  <span class="kw">alist</span>(
   gdpPercap  <span class="op">~</span><span class="st"> </span><span class="kw">dlnorm</span>( mu , sigma ),
    mu &lt;-<span class="st"> </span>a <span class="op">+</span><span class="st"> </span>b <span class="op">*</span><span class="st"> </span>lifeExp,
    a <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>( <span class="dv">0</span>, <span class="dv">10</span> ),
    b <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>( <span class="dv">0</span>, <span class="dv">10</span> ),
    sigma <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>( <span class="dv">0</span>, <span class="dv">2</span> ) 
   ), 
  <span class="dt">data =</span> g2007, 
  <span class="dt">start =</span> <span class="kw">list</span>( <span class="dt">a =</span> <span class="dv">3</span>, <span class="dt">b =</span> <span class="dv">0</span>, <span class="dt">sigma =</span> <span class="fl">0.5</span> ) 
  )</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">precis</span>(m_ln1)</code></pre></div>
<pre><code>##       Mean StdDev lower 0.89 upper 0.89 n_eff Rhat
## a     2.48   0.38       1.87       3.08   283    1
## b     0.09   0.01       0.08       0.10   287    1
## sigma 0.81   0.05       0.74       0.88   294    1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#plot(m_ln1)</span></code></pre></div>
<p>Logormaalses mudelis muutuvad parameetrite tähendused ja need tuleb lineaarse mudeli intercepti ja tõusu interpretatsioonidega kooskõlla viimiseks ümber arvutada. Kõigepealt avaldame tõusu. Kuna meil on tegemist mitte-lineaarse mudeliga, sõltub tõusu väärtus ka mudeli interceptist: <span class="math inline">\(slope = exp(\alpha + \beta)-exp(\alpha)\)</span>. See ei ole lineaarne seos: b omab seda suuremat mõju efektile (tõusule), mida suurem on a. [Kui meil on tegu binaarse X-ga (prediktoriga), siis kodeerime selle 2 taset kui -1 ja 1. Sellises mudelis on slope sama, mis efekti suurus ES, ja <span class="math inline">\(ES = exp(\alpha + \beta)-exp(\alpha-\beta)\)</span>]</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">a &lt;-<span class="st"> </span><span class="kw">seq</span>( <span class="dv">0</span>, <span class="dv">10</span>, <span class="dt">length.out =</span> <span class="dv">1000</span> )
b &lt;-<span class="st"> </span><span class="dv">2</span>
b1 &lt;-<span class="st"> </span><span class="dv">3</span>
y &lt;-<span class="st"> </span><span class="kw">exp</span>( a <span class="op">+</span><span class="st"> </span>b ) <span class="op">-</span><span class="st"> </span><span class="kw">exp</span>( a )
y1 &lt;-<span class="st"> </span><span class="kw">exp</span>( a <span class="op">+</span><span class="st"> </span>b1 ) <span class="op">-</span><span class="st"> </span><span class="kw">exp</span>( a )

<span class="kw">plot</span>( a, y, <span class="dt">type =</span> <span class="st">&quot;l&quot;</span>, <span class="dt">xlab =</span> <span class="st">&quot;a value&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;slope&quot;</span> )
<span class="kw">lines</span>( a, y1, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span> )</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-179"></span>
<img src="main_files/figure-html/unnamed-chunk-179-1.pdf" alt="Mudeli t&lt;U+00F5&gt;us s&lt;U+00F5&gt;ltub interceptist." width="288" />
<p class="caption">
Joonis 8.23: Mudeli t<U+00F5>us s<U+00F5>ltub interceptist.
</p>
</div>
<p>Must joon näitab mudeli tõusu sõltuvust parameetri a väärtusest, kui parameeter b = 2. Punane joon teeb sedasama, kui b = 3.</p>
<p>Selline on siis mudeli tõusude (beta) posteerior:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">s_ln1 &lt;-<span class="st"> </span><span class="kw">extract.samples</span>( m_ln1 ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.data.frame</span>()
beta &lt;-<span class="st"> </span><span class="kw">exp</span>(s_ln1<span class="op">$</span>a <span class="op">+</span><span class="st"> </span>s_ln1<span class="op">$</span>b) <span class="op">-</span><span class="st"> </span><span class="kw">exp</span>(s_ln1<span class="op">$</span>a)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dens</span>(beta)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-181"></span>
<img src="main_files/figure-html/unnamed-chunk-181-1.pdf" alt="Mudeli t&lt;U+00F5&gt;usude (beta) posteerior." width="288" />
<p class="caption">
Joonis 8.24: Mudeli t<U+00F5>usude (beta) posteerior.
</p>
</div>
<p>Lognormaaljaotusega mudelis täidab normaaljaotusega mudeli intercepti rolli eelkõige meedian, mis on defineeritud kui exp(a), aga arvutada saab ka keskmise:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">i_median &lt;-<span class="st"> </span><span class="kw">exp</span>( s_ln1<span class="op">$</span>a )
<span class="kw">mean</span>(i_median)</code></pre></div>
<pre><code>## [1] 12.85</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">i_mean &lt;-<span class="st"> </span><span class="kw">exp</span>( s_ln1<span class="op">$</span>a <span class="op">+</span><span class="st"> </span>s_ln1<span class="op">$</span>sigma<span class="op">**</span><span class="dv">2</span><span class="op">/</span><span class="dv">2</span> )
<span class="kw">mean</span>(i_mean)</code></pre></div>
<pre><code>## [1] 17.81</code></pre>
<p>Siin ennustame fititud mudelist uusi andmeid (väljamõeldud riikide rikkust):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sim_ci &lt;-<span class="st"> </span>rethinking<span class="op">::</span><span class="kw">sim</span>(m_ln1) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">apply</span>(<span class="dv">2</span>, HPDI, <span class="dt">prob =</span> <span class="fl">0.95</span>)</code></pre></div>
<pre><code>## [ 100 / 1000 ]
[ 200 / 1000 ]
[ 300 / 1000 ]
[ 400 / 1000 ]
[ 500 / 1000 ]
[ 600 / 1000 ]
[ 700 / 1000 ]
[ 800 / 1000 ]
[ 900 / 1000 ]
[ 1000 / 1000 ]</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(g2007, <span class="kw">aes</span>(lifeExp, gdpPercap)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> continent), <span class="dt">size =</span> <span class="fl">0.8</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>( <span class="dt">ymin =</span> sim_ci[<span class="dv">1</span>,], <span class="dt">ymax =</span> sim_ci[<span class="dv">2</span>,]), <span class="dt">alpha =</span> <span class="fl">0.2</span>)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-184"></span>
<img src="main_files/figure-html/unnamed-chunk-184-1.pdf" alt="Ennustus mudelist." width="672" />
<p class="caption">
Joonis 8.25: Ennustus mudelist.
</p>
</div>
<p>Ka see mudel jääb hätta Aafrika outlieritega, mille eluiga ei suuda ennustada rikkust.</p>
</div>
</div>
<div id="mitme-prediktoriga-lineaarne-regressioon" class="section level2">
<h2><span class="header-section-number">8.5</span> Mitme prediktoriga lineaarne regressioon</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">g2007 &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2007</span> ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">l_GDP =</span> <span class="kw">log10</span>(gdpPercap),
         <span class="dt">l_pop =</span> <span class="kw">log10</span>(pop), 
         <span class="dt">lpop_s =</span> (l_pop <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(l_pop )) <span class="op">/</span><span class="st"> </span><span class="kw">sd</span>(l_pop),
         <span class="dt">lGDP_s =</span> (l_GDP <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(l_GDP )) <span class="op">/</span><span class="st"> </span><span class="kw">sd</span>(l_GDP)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">as.data.frame</span>()</code></pre></div>
<p>Meil on võimalik lisada regressioonivõrrandisse lisaprediktoreid. Nüüd ei küsi me enam, kuidas mõjutab l_GDP varieeruvus keskmise eluea varieeruvust vaid: kuidas mõjutavad muutujad l_GDP, continent ja logaritm pop-ist (rahvaarvust) keskmist eluiga. Me modelleerime selle lineaarselt nii, et eeldusena varieeruvad need x-i muutujad üksteisest sõltumatult: y = a + b1x1 + b2x2 + b3x3</p>
<p>Sellise mudeli tõlgendus on suhteliselt lihtne:</p>
<blockquote>
<p>koef b1 ütleb meile, kui mitme ühiku võrra tõuseb/langeb muutuja y (eluiga) kui muutuja x1 (l_GDP) tõuseb 1 ühiku võrra; tingimusel, et me hoiame kõigi teiste muutujate väärtused konstantsed.</p>
</blockquote>
<p>Sarnane definitsioon kehtib ka kõigi teiste prediktorite (x-de) kohta.</p>
<p>Kui meil on mudelis SKP ja pop, siis saame küsida</p>
<ol style="list-style-type: decimal">
<li><p>kui me juba teame SKP-d, millist ennustuslikku lisaväärtust annab meile ka populatsiooni suuruse teadmine? ja</p></li>
<li><p>kui me juba teame populatsiooni suurust, millist lisaväärtust annab meile ka SKP teadmine?</p></li>
</ol>
<p>Järgenval mudelil on 4 parameetrit (intercept + 3 betat).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m1 &lt;-<span class="st"> </span><span class="kw">lm</span>(lifeExp <span class="op">~</span><span class="st"> </span>l_GDP <span class="op">+</span><span class="st"> </span>continent <span class="op">+</span><span class="st"> </span>l_pop, <span class="dt">data =</span> g2007)
<span class="kw">summary</span>( m1 )</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = lifeExp ~ l_GDP + continent + l_pop, data = g2007)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -19.425  -2.246  -0.014   2.468  14.957 
## 
## Coefficients:
##                   Estimate Std. Error t value Pr(&gt;|t|)
## (Intercept)        19.4182     7.4557    2.60   0.0102
## l_GDP              10.6876     1.2378    8.63  1.5e-14
## continentAmericas  11.6564     1.6929    6.89  2.0e-10
## continentAsia      10.0521     1.5776    6.37  2.7e-09
## continentEurope    11.2320     1.9265    5.83  3.9e-08
## continentOceania   12.8918     4.5493    2.83   0.0053
## l_pop               0.0928     0.8076    0.11   0.9087
##                      
## (Intercept)       *  
## l_GDP             ***
## continentAmericas ***
## continentAsia     ***
## continentEurope   ***
## continentOceania  ** 
## l_pop                
## ---
## Signif. codes:  
## 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 5.95 on 135 degrees of freedom
## Multiple R-squared:  0.767,  Adjusted R-squared:  0.757 
## F-statistic: 74.2 on 6 and 135 DF,  p-value: &lt;2e-16</code></pre>
<p>loeme mudelis “+” märki nagu “või”. Ehk, “eluiga võib olla funktsioon SKP-st <strong>või</strong> rahvaarvust”.</p>
<p>Intercept 19 ei tähenda tõlgenduslikult midagi. l-GDP tõus ühiku võrra tõstab eluiga 10.7 aasta võrra.</p>
<p>võrdluseks lihtne mudel</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m2 &lt;-<span class="st"> </span><span class="kw">lm</span>( lifeExp <span class="op">~</span><span class="st"> </span>l_GDP, <span class="dt">data =</span> g2007 )
<span class="kw">summary</span>( m2 )</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = lifeExp ~ l_GDP, data = g2007)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -25.95  -2.66   1.22   4.47  13.12 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)     4.95       3.86    1.28      0.2    
## l_GDP          16.59       1.02   16.28   &lt;2e-16 ***
## ---
## Signif. codes:  
## 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 7.12 on 140 degrees of freedom
## Multiple R-squared:  0.654,  Adjusted R-squared:  0.652 
## F-statistic:  265 on 1 and 140 DF,  p-value: &lt;2e-16</code></pre>
<p>Siin on l_GDP mõju suurem, 16.6 aastat. Millisel mudelil on siis õigus? Proovime veel ülejäänud variendid</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m3 &lt;-<span class="st"> </span><span class="kw">lm</span>(lifeExp <span class="op">~</span><span class="st"> </span>l_GDP <span class="op">+</span><span class="st"> </span>continent, <span class="dt">data =</span> g2007)
<span class="kw">summary</span>( m3 )</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = lifeExp ~ l_GDP + continent, data = g2007)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -19.492  -2.315  -0.043   2.550  14.882 
## 
## Coefficients:
##                   Estimate Std. Error t value Pr(&gt;|t|)
## (Intercept)          20.14       4.03    4.99  1.8e-06
## l_GDP                10.66       1.21    8.78  6.1e-15
## continentAmericas    11.69       1.65    7.07  7.5e-11
## continentAsia        10.11       1.48    6.85  2.3e-10
## continentEurope      11.27       1.89    5.95  2.1e-08
## continentOceania     12.93       4.52    2.86   0.0049
##                      
## (Intercept)       ***
## l_GDP             ***
## continentAmericas ***
## continentAsia     ***
## continentEurope   ***
## continentOceania  ** 
## ---
## Signif. codes:  
## 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 5.93 on 136 degrees of freedom
## Multiple R-squared:  0.767,  Adjusted R-squared:  0.759 
## F-statistic: 89.7 on 5 and 136 DF,  p-value: &lt;2e-16</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m4 &lt;-<span class="st"> </span><span class="kw">lm</span>(lifeExp <span class="op">~</span><span class="st"> </span>l_GDP <span class="op">+</span><span class="st"> </span>l_pop, <span class="dt">data =</span> g2007 )
<span class="kw">AIC</span>( m1, m2, m3, m4 )</code></pre></div>
<pre><code>##    df   AIC
## m1  8 918.3
## m2  3 964.5
## m3  7 916.3
## m4  4 962.1</code></pre>
<p>Võitja mudel on hoopis m3, mis võtab arvesse kontinendi. Siin on l_GDP mõju samuti 10.7 aastat. Lisaks näeme, et kui riik ei asu Aafrikas, siis on l_GDP mõju elueale u 11 aasta võrra suurem. Seega elu Aafrika kisub alla keskmise eluea riigi rikkusest sõltumata. Võib olla on põhjuseks sõjad, võib-olla AIDS ja malaaria, võib-olla midagi muud.</p>
<p>Millise mudeli me peaksime siis avaldama? Vastus on, et need kõik on olulised, et vastata küsimusele, millised faktorid kontrollivad keskmist eluiga? Mudelite võrdlusest näeme, et rahvaarvu mõju elueale on väike või olematu ning et SKP mõju avaldub log skaalas (viitab teatud tüüpi eksponentsiaalsetele protsessidele, kus rikkus tekitab uut rikkust) ning, et Aafrikaga on midagi pahasti ja teistmoodi kui teiste kontinentidega. Aafrikast tasub otsida midagi, mida meie senised mudelid ei kajasta.</p>
<p>Miks ei ole mudeli summary tabelis Aafrikat? Põhjus on tehniline. Kategoorilisi muutujaid, nagu kontinent, vaatab mudel paariviisilises võrdluses, mis tähendab et k erineva tasemega muutujast tekitatakse k - 1 uut muutujat, millest igaühel on kaks taset (0 ja 1). See algne muutuja, mis üle jääb (antud juhul Africa), jääb ilma oma uue muutujata. Me saame teisi uusi kontinendi põhjal tehtud muutujaid tõlgendada selle järgi, kui palju nad erinevad Africa-st.</p>
<div id="miks-multivariaatsed-mudelid-head-on" class="section level4">
<h4><span class="header-section-number">8.5.0.1</span> Miks multivariaatsed mudelid head on?</h4>
<ol style="list-style-type: decimal">
<li><p>nad aitavad kontrollida “confounding” muutujaid. Confounding muutuja võib olla korreleeritud mõne teise muutujaga, mis meile huvi pakub. See võib nii maskeerida signaali, kui tekitada võlts-signaali, kuni y ja x1 seose suuna muutmiseni välja.</p></li>
<li><p>ühel tagajärjel võib olla mitu põhjust.</p></li>
<li><p>Isegi kui muutujad ei ole omavahel üldse korreleeritud, võib ühe tähtsus sõltuda teise väärtusest. Näiteks taimed vajavad nii valgust kui vett. Aga kui ühte ei ole, siis pole ka teisel suurt tähtsust.</p></li>
</ol>
</div>
<div id="mudeldamine-standardiseeritud-andmetega." class="section level3">
<h3><span class="header-section-number">8.5.1</span> Mudeldamine standardiseeritud andmetega.</h3>
<p>Kui me lahutame igast andmepunktist selle muutuja keskväärtuse siis saame 0-le tsentreeritud andmed. Kui me sellisel viisil saadud väärtused omakorda läbi jagame muutuja standardhälbega, siis saame standardiseeritud andmed, mille keskväärtus on null ja SD = 1.</p>
<p><span class="math inline">\(Standard.andmed = (x - mean(x))/sd(x)\)</span></p>
<p>Nii on lihtsam erinevas skaalas muutujaid omavahel võrrelda (1 ühikuline muutus võrdub alati muutusega 1 standardhäve võrra) ja mudeli arvutamine üle mcmc ahelate on ka lihtsam.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m5 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(
    <span class="kw">alist</span>(
        lifeExp <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>( mu , sigma ) ,
        mu &lt;-<span class="st"> </span>a <span class="op">+</span><span class="st"> </span>b_GDP <span class="op">*</span><span class="st"> </span>lGDP_s <span class="op">+</span><span class="st"> </span>b_pop <span class="op">*</span><span class="st"> </span>lpop_s ,
        a <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>( <span class="dv">0</span> , <span class="dv">10</span> ) ,
        <span class="kw">c</span>(b_GDP, b_pop) <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>( <span class="dv">0</span> , <span class="dv">1</span> ) ,
        sigma <span class="op">~</span><span class="st"> </span><span class="kw">dunif</span>( <span class="dv">0</span> , <span class="dv">10</span> )
),
    <span class="dt">data =</span> g2007 )</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">precis</span>( m5 )</code></pre></div>
<pre><code>##        Mean StdDev lower 0.89 upper 0.89 n_eff Rhat
## a     66.74   0.64      65.77      67.79  1000    1
## b_GDP  6.95   0.58       6.06       7.84   775    1
## b_pop  0.80   0.55      -0.11       1.58   870    1
## sigma  7.64   0.50       6.82       8.40   876    1</code></pre>
<p>kui l_GDP kasvab 1 sd võrra, siis eluiga kasvab 6.9 aasta võrra.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f1 &lt;-<span class="st"> </span><span class="kw">glimmer</span>( lifeExp <span class="op">~</span><span class="st"> </span>lGDP_s <span class="op">+</span><span class="st"> </span>lpop_s <span class="op">+</span><span class="st"> </span>continent, <span class="dt">data =</span> g2007 )</code></pre></div>
<pre><code>## alist(
##     lifeExp ~ dnorm( mu , sigma ),
##     mu &lt;- Intercept +
##         b_lGDP_s*lGDP_s +
##         b_lpop_s*lpop_s +
##         b_continentAmericas*continentAmericas +
##         b_continentAsia*continentAsia +
##         b_continentEurope*continentEurope +
##         b_continentOceania*continentOceania,
##     Intercept ~ dnorm(0,10),
##     b_lGDP_s ~ dnorm(0,10),
##     b_lpop_s ~ dnorm(0,10),
##     b_continentAmericas ~ dnorm(0,10),
##     b_continentAsia ~ dnorm(0,10),
##     b_continentEurope ~ dnorm(0,10),
##     b_continentOceania ~ dnorm(0,10),
##     sigma ~ dcauchy(0,2)
## )</code></pre>
<p>See on mudeli struktuur, mis sisaldab uusi kategoorilisi muutujaid</p>
<p>Siin on tähtis anda map2stan()-le ette glimmeri poolt eeltöödeldud andmed:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m6 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(
  f1<span class="op">$</span>f, 
  <span class="dt">data =</span> f1<span class="op">$</span>d
)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">precis</span>( m6 )</code></pre></div>
<pre><code>##                      Mean StdDev lower 0.89 upper 0.89
## Intercept           59.92   0.97      58.31      61.42
## b_lGDP_s             6.29   0.68       5.20       7.31
## b_lpop_s             0.06   0.50      -0.75       0.79
## b_continentAmericas 11.66   1.53       9.07      13.94
## b_continentAsia     10.11   1.47       7.87      12.51
## b_continentEurope   11.26   1.83       8.50      14.26
## b_continentOceania  11.18   4.00       4.87      17.50
## sigma                5.95   0.36       5.38       6.49
##                     n_eff Rhat
## Intercept             344    1
## b_lGDP_s              450    1
## b_lpop_s             1000    1
## b_continentAmericas   436    1
## b_continentAsia       428    1
## b_continentEurope     434    1
## b_continentOceania    784    1
## sigma                 931    1</code></pre>
</div>
</div>
<div id="keerulisemate-mudelitega-tootamine" class="section level2">
<h2><span class="header-section-number">8.6</span> Keerulisemate mudelitega töötamine</h2>
<p>Kasuta graafilisi meetodied. Mudeli koefitsientide jõllitamine üksi ei päästa.</p>
<div id="predictor-residual-plots." class="section level3">
<h3><span class="header-section-number">8.6.1</span> Predictor residual plots.</h3>
<p>Plotime varieeruvuse, mida mudel ei oota ega seleta.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">names</span>( <span class="kw">coef</span>( m5 ) )</code></pre></div>
<pre><code>## [1] &quot;a&quot;     &quot;b_GDP&quot; &quot;b_pop&quot; &quot;sigma&quot;</code></pre>
<p>Kõigepealt lihtne residuaalide plot, kus meil on y-teljel residuaalid ja x-teljel X1 muutuja tegelikud valimiväärtused. Y = 0 tähistab horisontaalse joonena mudeli ennustatud Y (eluea) väärtusi kõigil prediktori X1 (lGDP_s) väärtustel ja residuaal on defineeritud kui tegelik Y miinus mudeli poolt ennustatud eluiga sellel X1 väärtusel. Mudeli ennustuse saamiseks anname mudelile ette fikseeritud parameetrite (koefitsientide) a, b_GDP ja b_pop väärtused ning arvutame oodatava keskmise eluea üle kõigi valimis leiduvate lGDP_s ja lpop_s väärtuste. Seega saame sama palju keskmise eluea ennustusi, kui palju on meie andmetabelis ridu.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Using the fitted model compute the expected value of y (mu) </span>
<span class="co"># for each of the 142 data rows.</span>
mu &lt;-<span class="st"> </span><span class="kw">coef</span>( m5 )[ <span class="st">&#39;a&#39;</span> ] <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">coef</span>( m5 )[ <span class="st">&#39;b_GDP&#39;</span> ] <span class="op">*</span><span class="st"> </span>g2007<span class="op">$</span>lGDP_s <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">coef</span>( m5 )[ <span class="st">&#39;b_pop&#39;</span> ] <span class="op">*</span><span class="st"> </span>g2007<span class="op">$</span>lpop_s

<span class="co"># compute residuals - a vector w. 142 values</span>
m.resid &lt;-<span class="st"> </span>g2007<span class="op">$</span>lifeExp <span class="op">-</span><span class="st"> </span>mu

<span class="kw">ggplot</span>( g2007, <span class="kw">aes</span>( lGDP_s, m.resid ) ) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_segment</span>( <span class="kw">aes</span>( <span class="dt">xend =</span> lGDP_s, <span class="dt">yend =</span> <span class="dv">0</span> ), <span class="dt">size =</span> <span class="fl">0.2</span> ) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>( <span class="dt">size =</span> <span class="fl">0.5</span>, <span class="dt">type =</span> <span class="dv">1</span> )</code></pre></div>
<pre><code>## Warning: Ignoring unknown parameters: type</code></pre>
<div class="figure"><span id="fig:unnamed-chunk-197"></span>
<img src="main_files/figure-html/unnamed-chunk-197-1.pdf" alt="Mudeli residuaalide plot (m.resid ~ X1)." width="672" />
<p class="caption">
Joonis 8.26: Mudeli residuaalide plot (m.resid ~ X1).
</p>
</div>
<p>Me näeme, et seal kus SKP on väiksem kipuvad residuaalid olema negatiivsed, mis tähendab, et mudel ülehindab keskmist eluiga. Ja vastupidi, seal kus SKP on üle keskmise, mudel kipub alahindma keskmist eluiga.</p>
<p>See seos tuleb eriti selgelt välja järgmisel pildil, kus plotime residuaalide sõltuvuse elueast (kui eelmine plot oli m.resid ~ X1, siis nüüd plotime m.resid ~ Y). Lisaks joonistame selguse mõttes regressioonisirge. Kui residuaalid oleks ühtlaselt jaotunud mõlemale poole mudeli ennustust, siis saaksime horisontaalse regressioonisirge. Tegeliku sirge tõus näitab, et suuremad eluead omavad eelistatult poitiivseid residuaale ja väiksemad eluead negatiivseid residuaale. See tähendab, et mudel alahindab eluiga seal, kus SKP on kõrge ja vastupidi, ülehindab eluiga seal, kus SKP on madal.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">g2007<span class="op">$</span>m.resid &lt;-<span class="st"> </span>m.resid
<span class="kw">ggplot</span>(g2007, <span class="kw">aes</span>(lifeExp, m.resid)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;grey&quot;</span>, <span class="dt">linetype =</span> <span class="dv">2</span>)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-198"></span>
<img src="main_files/figure-html/unnamed-chunk-198-1.pdf" alt="m.resid ~ Y plot" width="384" />
<p class="caption">
Joonis 8.27: m.resid ~ Y plot
</p>
</div>
<p>Horisontaalne punktiirjoon näitab, kus mudel vastab täpselt andmetele.</p>
<div id="ennustavad-plotid" class="section level4">
<h4><span class="header-section-number">8.6.1.1</span> ennustavad plotid:</h4>
<p>Plot, kus me ennustame keskmise eluea sõltuvust SKP-st nii riikide kaupa eraldi (andmepunktide paupa) kui üldiselt kõikide riikide keskmisena, millel on mingi kindel SKP (mudeli parima ennustuse ehk sirge asendi ümber valitsevat ebakindlust). Et seda teha, hoiame rahvaarvu konstantsena oma keskväärtusel, mis standardiseeritud andmetl võrdub alati nulliga. link() funktsioon annab meile keskmiste eluigade ennustused meie poolt ette antud X1 ja X2 väärtustel, ning sim() annab meile eluigade ennustused fiktsionaalsete riikide kaupa samadel X1 ja X2 väärtustel. Nagu näha, on meie mudeli arvates riikide kaupa ennustamine palju laiema varieeruvusega kui üle kõikväimalike riikide kesmise kaupa ennustamine.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># prepare new counterfactual data</span>
pred.data &lt;-<span class="st"> </span><span class="kw">tibble</span>(
    <span class="dt">lGDP_s =</span> <span class="kw">seq</span>(<span class="op">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="dt">length.out =</span> <span class="dv">30</span>), <span class="co"># need meie poolt valitud lGDP_s väärtused, millele me ennustame vastavad eluead </span>
    <span class="dt">lpop_s =</span> <span class="dv">0</span> <span class="co"># rahvaarv fikseeritakse muutuja keskmisele tasemele, mis standardiseeritud andmete korral = 0</span>
)

<span class="co"># compute counterfactual mean lifeExp (mu)</span>
mu &lt;-<span class="st"> </span><span class="kw">link</span>(m5, <span class="dt">data =</span> pred.data)</code></pre></div>
<pre><code>## [ 100 / 1000 ]
[ 200 / 1000 ]
[ 300 / 1000 ]
[ 400 / 1000 ]
[ 500 / 1000 ]
[ 600 / 1000 ]
[ 700 / 1000 ]
[ 800 / 1000 ]
[ 900 / 1000 ]
[ 1000 / 1000 ]</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mu.mean &lt;-<span class="st"> </span><span class="kw">apply</span>(mu, <span class="dv">2</span>, mean)
mu.PI &lt;-<span class="st"> </span><span class="kw">apply</span>(mu, <span class="dv">2</span>, PI)

<span class="co"># simulate counterfactual lifeExpectancies of individual countries</span>
R.sim &lt;-<span class="st"> </span>rethinking<span class="op">::</span><span class="kw">sim</span>(m5, <span class="dt">data =</span> pred.data)</code></pre></div>
<pre><code>## [ 100 / 1000 ]
[ 200 / 1000 ]
[ 300 / 1000 ]
[ 400 / 1000 ]
[ 500 / 1000 ]
[ 600 / 1000 ]
[ 700 / 1000 ]
[ 800 / 1000 ]
[ 900 / 1000 ]
[ 1000 / 1000 ]</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">R.sim &lt;-<span class="st"> </span><span class="kw">na.omit</span>(R.sim)
R.PI &lt;-<span class="st"> </span><span class="kw">apply</span>(R.sim, <span class="dv">2</span>, PI)

<span class="kw">ggplot</span>(pred.data, <span class="kw">aes</span>(lGDP_s, mu.mean)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">y =</span> mu.mean) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">ymin =</span> mu.PI[<span class="dv">1</span>,], <span class="dt">ymax =</span> mu.PI[<span class="dv">2</span>,], <span class="dt">fill =</span> <span class="st">&quot;grey60&quot;</span>, <span class="dt">alpha =</span> <span class="fl">0.3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">ymin =</span> R.PI[<span class="dv">1</span>,], <span class="dt">ymax =</span> R.PI[<span class="dv">2</span>,], <span class="dt">fill =</span> <span class="st">&quot;grey10&quot;</span>, <span class="dt">alpha =</span> <span class="fl">0.3</span>)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-199"></span>
<img src="main_files/figure-html/unnamed-chunk-199-1.pdf" alt="Ennustav plot" width="384" />
<p class="caption">
Joonis 8.28: Ennustav plot
</p>
</div>
<p>Näeme, kuidas ennustus sobib/ei sobi andmetega. Võrdle eelneva ennustuspildiga, kus mudel ei sisalda rahvaarvu. Ennustuse intervallid on originaalandmete skaalas (aastates), mis on hea.</p>
</div>
</div>
<div id="posterior-prediction-plots" class="section level3">
<h3><span class="header-section-number">8.6.2</span> Posterior prediction plots</h3>
<p>Posterioorsed ennustusplotid panevad kõrvuti (või üksteise otsa) Y-i algandmed ja mudeli ennustused Y-väärtustele. Kui meie valimi suurus on N, siis me tõmbame mudelist näiteks 5 valimit, igaüks suurusega N ja plotime need kõrvuti valimiandmete plotiga. Siis me vaatame sellele plotile peale ja otsustame, kas mudeli ennustused on piisavalt lähedal valimi andmetele. Kui ei, siis on tõenäoline, et meie mudelis on midagi mäda ja me peame hakkama sealt vigu otsima. Tõsi küll, keerulisemate hierarhiliste mudelite korral on vahest raske otsustada, millised peaksid tulema eduka mudeli ennustused võrreldes algandmetega — aga siiski, see on arvatavasti kõige tähtsam plot, mida oma mudelist teha!</p>
<ol style="list-style-type: decimal">
<li>võrdle mudeli ennustusi andmetega. (Aga arvesta sellega, et mitte kõik mudelid ei püüagi täpselt andmetele vastata.)</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">yrep &lt;-<span class="st"> </span>rethinking<span class="op">::</span><span class="kw">sim</span>(m5)</code></pre></div>
<pre><code>## [ 100 / 1000 ]
[ 200 / 1000 ]
[ 300 / 1000 ]
[ 400 / 1000 ]
[ 500 / 1000 ]
[ 600 / 1000 ]
[ 700 / 1000 ]
[ 800 / 1000 ]
[ 900 / 1000 ]
[ 1000 / 1000 ]</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ppc_dens</span>(g2007<span class="op">$</span>lifeExp, yrep[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, ])</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-200"></span>
<img src="main_files/figure-html/unnamed-chunk-200-1.pdf" alt="valimi andmed vs. mudeli poolt ennustatud andmed." width="480" />
<p class="caption">
Joonis 8.29: valimi andmed vs. mudeli poolt ennustatud andmed.
</p>
</div>
<ol start="2" style="list-style-type: decimal">
<li>Millisel viisil täpselt meie mudel ebaõnnestub? See plot annab mõtteid, kuidas mudelit parandada.</li>
</ol>
<p>Ploti ennustused andmepunktide vastu, pluss jooned, mis näitavad igale ennustusele omistatud usaldusintervalli. Lisaks veel sirge, mis näitab täiuslikku ennustust (slope = 1, intercept = 0).</p>
<p>Loeme gapminderi andmed uuesti sisse:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">g2007 &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>( year <span class="op">==</span><span class="st"> </span><span class="dv">2007</span> )
g2007 &lt;-<span class="st"> </span>g2007 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>( <span class="dt">l_GDP =</span> <span class="kw">log10</span>( gdpPercap ) )
g2007 &lt;-<span class="st"> </span>g2007 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>( <span class="dt">l_pop =</span> <span class="kw">log10</span>( pop ), 
                           <span class="dt">lpop_s =</span> (l_pop <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>( l_pop ) )<span class="op">/</span><span class="kw">sd</span>( l_pop ),
                           <span class="dt">lGDP_s =</span> (l_GDP <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>( l_GDP ) )<span class="op">/</span><span class="kw">sd</span>( l_GDP ) ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">as.data.frame</span>()</code></pre></div>
<p>Ja nüüd plotime ennustused Y-le tegelike Y valimi väärtuste vastu:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mu &lt;-<span class="st"> </span><span class="kw">link</span>(m5)  </code></pre></div>
<pre><code>## [ 100 / 1000 ]
[ 200 / 1000 ]
[ 300 / 1000 ]
[ 400 / 1000 ]
[ 500 / 1000 ]
[ 600 / 1000 ]
[ 700 / 1000 ]
[ 800 / 1000 ]
[ 900 / 1000 ]
[ 1000 / 1000 ]</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mu.mean &lt;-<span class="st"> </span><span class="kw">apply</span>(mu, <span class="dv">2</span>, mean)

mu.PI &lt;-<span class="st"> </span><span class="kw">apply</span>( mu , <span class="dv">2</span> , PI )

g2007<span class="op">$</span>mu.mean &lt;-<span class="st"> </span>mu.mean

<span class="kw">ggplot</span>(g2007, <span class="kw">aes</span>(lifeExp, mu.mean)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_crossbar</span>(<span class="dt">ymin =</span> mu.PI[<span class="dv">1</span>,], <span class="dt">ymax =</span> mu.PI[<span class="dv">2</span>,]) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>, <span class="dt">lty =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Predicted life expectancy&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Observed life expectancy&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_cartesian</span>( <span class="dt">xlim=</span><span class="kw">c</span>( <span class="dv">40</span>, <span class="dv">85</span> ), <span class="dt">ylim=</span><span class="kw">c</span>( <span class="dv">40</span>, <span class="dv">85</span> ))</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-202"></span>
<img src="main_files/figure-html/unnamed-chunk-202-1.pdf" alt="Ennustus vs. valimi v&lt;U+00E4&gt;&lt;U+00E4&gt;rtus" width="480" />
<p class="caption">
Joonis 8.30: Ennustus vs. valimi v<U+00E4><U+00E4>rtus
</p>
</div>
<p>Siin on ennustus ja seda ümbritsev ebakindlus iga riigi keskmisele elueale.</p>
<p>Järgnev plot annab ennustusvea igale riigile. Siin tähistab 89% CI näiteks Vietnamile eluigade vahemikku, millese jääb mudeli ennustuse kohaselt 89% kõikvõimalike fiktsionaalsete riikide keskmistest eluigadest, mille SKP ja rahvaarv võrdub Vietnami omaga. Kuna me tsentreerime CI Vietnami tegeliku keskmise eluea residuaalile (erinevusele mudeli ennustusest), näitab see, kui palju erineb Vietnami eluiga mudeli ennustusest riikidele, nagu Vietnam. See plot annab meile riigid, mille suhtes mudel jänni jääb. Enamasti leiame need riigid Aafrikast.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># compute residuals</span>
life.resid &lt;-<span class="st"> </span>g2007<span class="op">$</span>lifeExp <span class="op">-</span><span class="st"> </span>mu.mean

mu_sim &lt;-<span class="st"> </span>rethinking<span class="op">::</span><span class="kw">sim</span>( m5 )  </code></pre></div>
<pre><code>## [ 100 / 1000 ]
[ 200 / 1000 ]
[ 300 / 1000 ]
[ 400 / 1000 ]
[ 500 / 1000 ]
[ 600 / 1000 ]
[ 700 / 1000 ]
[ 800 / 1000 ]
[ 900 / 1000 ]
[ 1000 / 1000 ]</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sim.PI &lt;-<span class="st"> </span><span class="kw">apply</span>( mu_sim , <span class="dv">2</span> , PI )

<span class="kw">ggplot</span>( g2007, <span class="kw">aes</span>( <span class="dt">x =</span> life.resid, <span class="dt">y =</span> <span class="kw">reorder</span>( country, life.resid ) ) ) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_errorbarh</span>( <span class="kw">aes</span>( <span class="dt">xmin =</span> lifeExp <span class="op">-</span><span class="st"> </span>sim.PI[<span class="dv">1</span>,], 
                       <span class="dt">xmax =</span> lifeExp <span class="op">-</span><span class="st"> </span>sim.PI[<span class="dv">2</span>,] ), 
                  <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_vline</span>( <span class="dt">xintercept =</span> <span class="dv">0</span> ) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">7</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.title.y =</span> <span class="kw">element_blank</span>())</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-203"></span>
<img src="main_files/figure-html/unnamed-chunk-203-1.pdf" alt="Ennustused riigi kaupa." width="480" />
<p class="caption">
Joonis 8.31: Ennustused riigi kaupa.
</p>
</div>
<p>punased jooned näitavad 89% ennustuspiire igale residuaalile riigi tasemel (89% kõikvõimalike riikide keskmiste eluigade residuaalidest sellel SKPl jääb punasesse vahemikku).</p>
</div>
<div id="interaktsioonid-prediktorite-vahel" class="section level3">
<h3><span class="header-section-number">8.6.3</span> interaktsioonid prediktorite vahel</h3>
<p>Eelnevad mudelid eeldavad, et prediktorite varieeruvused on üksteisest sõltumatud. Aga mis siis, kui see nii ei ole ja ühe prediktori mõju suurus sõltub teisest prediktorist, ehk prediktorite vahel on interaktsioon? Lihtsaim viis sellist interaktsiooni modelleerida on lisades interaktsiooni aditiivsele mudelile korrutamisetehtena:</p>
<p><span class="math inline">\(y = a + b1x1 + b2x2 + b3x1x2\)</span></p>
<p>Sellise mudeli järgi erineb sirge tõus b1 erinevatel b2 väärtustel, ja erinevuse määr sõltub b3-st (b3 annab interaktsiooni tugevuse). Samamoodi ja sümmeetriliselt erineb ka tõus b2 sõltuvalt b1 väärtusest. See on ühine paljude hierarhiliste mudelitega, mida võib omakorda vaadelda massivsete interaktsioonimudelitena. Seevastu y = a + b1x1 + b2x2 tüüpi mudel annab b1-le konstantse tõusunurga, kuid laseb intercepti muutuma sõltuvalt b2 väärtusest (ja vastupidi).</p>
<p>Interaktsioonimudeli fittimises pole midagi erilist võrreldes sellega, mida me oleme juba õppinud. Aga fititud parameetrite tõlgendamine on keeruline. Alustame diskreetse muutujaga, continent, ja mudeldame selle interaktsiooni SKP-ga.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f1 &lt;-<span class="st"> </span><span class="kw">glimmer</span>(lifeExp <span class="op">~</span><span class="st"> </span>lGDP_s <span class="op">*</span><span class="st"> </span>continent, <span class="dt">data =</span> g2007)</code></pre></div>
<pre><code>## alist(
##     lifeExp ~ dnorm( mu , sigma ),
##     mu &lt;- Intercept +
##         b_lGDP_s*lGDP_s +
##         b_continentAmericas*continentAmericas +
##         b_continentAsia*continentAsia +
##         b_continentEurope*continentEurope +
##         b_continentOceania*continentOceania +
##         b_lGDP_s_X_continentAmericas*lGDP_s_X_continentAmericas +
##         b_lGDP_s_X_continentAsia*lGDP_s_X_continentAsia +
##         b_lGDP_s_X_continentEurope*lGDP_s_X_continentEurope +
##         b_lGDP_s_X_continentOceania*lGDP_s_X_continentOceania,
##     Intercept ~ dnorm(0,10),
##     b_lGDP_s ~ dnorm(0,10),
##     b_continentAmericas ~ dnorm(0,10),
##     b_continentAsia ~ dnorm(0,10),
##     b_continentEurope ~ dnorm(0,10),
##     b_continentOceania ~ dnorm(0,10),
##     b_lGDP_s_X_continentAmericas ~ dnorm(0,10),
##     b_lGDP_s_X_continentAsia ~ dnorm(0,10),
##     b_lGDP_s_X_continentEurope ~ dnorm(0,10),
##     b_lGDP_s_X_continentOceania ~ dnorm(0,10),
##     sigma ~ dcauchy(0,2)
## )</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m1 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(f1<span class="op">$</span>f, f1<span class="op">$</span>d)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="kw">precis</span>(m1))</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-207"></span>
<img src="main_files/figure-html/unnamed-chunk-207-1.pdf" alt="Mudeli koefitsientide plot." width="672" />
<p class="caption">
Joonis 8.32: Mudeli koefitsientide plot.
</p>
</div>
<p>Aafrika on siin võrdluseks.</p>
<p>Interaktsioon on sümmeetriline. Me võime sama hästi küsida, kui palju SKP mõju elueale sõltub kontinendist, kui seda, kui palju kontinendi mõju eluale sõltub SKP-st.</p>
<p>Nüüd joonistame välja regressioonisirge Aafrika ja Euroopa jaoks eraldi m1 mudeli põhjal</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">c1 &lt;-<span class="st"> </span><span class="kw">coef</span>(m1)
<span class="kw">names</span>(c1)</code></pre></div>
<pre><code>##  [1] &quot;Intercept&quot;                   
##  [2] &quot;b_lGDP_s&quot;                    
##  [3] &quot;b_continentAmericas&quot;         
##  [4] &quot;b_continentAsia&quot;             
##  [5] &quot;b_continentEurope&quot;           
##  [6] &quot;b_continentOceania&quot;          
##  [7] &quot;b_lGDP_s_X_continentAmericas&quot;
##  [8] &quot;b_lGDP_s_X_continentAsia&quot;    
##  [9] &quot;b_lGDP_s_X_continentEurope&quot;  
## [10] &quot;b_lGDP_s_X_continentOceania&quot; 
## [11] &quot;sigma&quot;</code></pre>
<p>Kõigepealt defineerime X1 ja X2 väärtused, millele teeme ennustused link() funktsiooni abil. Link tabelist veergude keskmine annab keskmise eluea ennustuse vastavale mandrile ja SKP-le. PI() abil saame 89% CI igale ennustusele.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dd &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(f1<span class="op">$</span>d) <span class="co">#we use the dataframe made by glimmer()</span>
<span class="co">#in dd all continents are in separate 2-level columns (except Africa)</span>
dd1 &lt;-<span class="st"> </span>dd <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(continentAmericas <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, 
                     continentAsia <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, 
                     continentEurope <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, 
                     continentOceania <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)
mu.Africa &lt;-<span class="st"> </span><span class="kw">link</span>(m1, dd1)</code></pre></div>
<pre><code>## [ 100 / 1000 ]
[ 200 / 1000 ]
[ 300 / 1000 ]
[ 400 / 1000 ]
[ 500 / 1000 ]
[ 600 / 1000 ]
[ 700 / 1000 ]
[ 800 / 1000 ]
[ 900 / 1000 ]
[ 1000 / 1000 ]</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mu.Africa.mean &lt;-<span class="st"> </span><span class="kw">apply</span>(mu.Africa, <span class="dv">2</span>, mean)
mu.Africa.PI &lt;-<span class="st"> </span><span class="kw">apply</span>(mu.Africa, <span class="dv">2</span>, PI, <span class="dt">prob =</span> <span class="fl">0.9</span>)

<span class="kw">ggplot</span>(dd1, <span class="kw">aes</span>(lGDP_s, lifeExp)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> mu.Africa.PI[<span class="dv">1</span>,], <span class="dt">ymax =</span> mu.Africa.PI[<span class="dv">2</span>,]), <span class="dt">alpha =</span> <span class="fl">0.15</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> mu.Africa.mean))</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-209"></span>
<img src="main_files/figure-html/unnamed-chunk-209-1.pdf" alt="Ennustusplot Aafrikale." width="384" />
<p class="caption">
Joonis 8.33: Ennustusplot Aafrikale.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dd1 &lt;-<span class="st"> </span>dd <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(continentEurope <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)
mu.Europe &lt;-<span class="st"> </span><span class="kw">link</span>(m1, dd1)</code></pre></div>
<pre><code>## [ 100 / 1000 ]
[ 200 / 1000 ]
[ 300 / 1000 ]
[ 400 / 1000 ]
[ 500 / 1000 ]
[ 600 / 1000 ]
[ 700 / 1000 ]
[ 800 / 1000 ]
[ 900 / 1000 ]
[ 1000 / 1000 ]</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mu.Europe.mean &lt;-<span class="st"> </span><span class="kw">apply</span>( mu.Europe , <span class="dv">2</span> , mean )
mu.Europe.PI &lt;-<span class="st"> </span><span class="kw">apply</span>( mu.Europe , <span class="dv">2</span> , PI , <span class="dt">prob=</span><span class="fl">0.9</span> )

<span class="kw">ggplot</span>(<span class="dt">data=</span>dd1, <span class="kw">aes</span>(lGDP_s, lifeExp)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ribbon</span>( <span class="kw">aes</span>(<span class="dt">ymin=</span>mu.Europe.PI[<span class="dv">1</span>,], <span class="dt">ymax=</span>mu.Europe.PI[<span class="dv">2</span>,]), <span class="dt">alpha=</span><span class="fl">0.15</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>( <span class="kw">aes</span>( <span class="dt">y=</span>mu.Europe.mean))</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-210"></span>
<img src="main_files/figure-html/unnamed-chunk-210-1.pdf" alt="Ennustusplot Euroopale." width="384" />
<p class="caption">
Joonis 8.34: Ennustusplot Euroopale.
</p>
</div>
<p>Nagu näha, on meil nüüd üsna erinevad sirge tõusunurgad.</p>
</div>
<div id="interaktsioonid-pidevatele-tunnustele" class="section level3">
<h3><span class="header-section-number">8.6.4</span> Interaktsioonid pidevatele tunnustele</h3>
<p>Kasutame standardiseeritud prediktoreid, sest nende koefitsiente saab paremini tõlgendada (tegelikult piisab prediktorite tsentreerimisest). Meie andmed käsitlevad diabeedimarkereid Ameerika lõunaosariikide neegritel 1960-ndatel. Me ennustame siin sõltuvalt vanusest ja vööümbermõõdust hdl-i — high density cholesterol — mis on nn hea kolesterool.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#diabetes &lt;- read.table( file = &#39;data/diabetes.csv&#39;, header = TRUE, sep = &#39;;&#39;, dec = &#39;,&#39; )</span>
diabetes &lt;-<span class="st"> </span><span class="kw">read.csv2</span>( <span class="st">&quot;data/diabetes.csv&quot;</span> )
d1 &lt;-<span class="st"> </span>diabetes <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>( hdl, age, waist ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">na.omit</span>()
d2 &lt;-<span class="st"> </span>d1 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>( <span class="dt">age_st =</span> ( age <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>( age ) )<span class="op">/</span><span class="kw">sd</span>( age ), 
                    <span class="dt">waist_st =</span> ( waist <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>( waist ) )<span class="op">/</span><span class="kw">sd</span>( waist ) )</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m2 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(
    <span class="kw">alist</span>(
        hdl <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>( mu , sigma ) ,
        mu &lt;-<span class="st"> </span>a <span class="op">+</span><span class="st"> </span>bR<span class="op">*</span>age_st <span class="op">+</span><span class="st"> </span>bA<span class="op">*</span>waist_st <span class="op">+</span><span class="st"> </span>bAR<span class="op">*</span>age_st<span class="op">*</span>waist_st,
        a <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>( <span class="dv">0</span>, <span class="dv">100</span> ),
        bR <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>( <span class="dv">0</span>, <span class="dv">2</span> ),
        bA <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>( <span class="dv">0</span>, <span class="dv">2</span> ),
        bAR<span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>( <span class="dv">0</span>, <span class="dv">2</span>),
        sigma <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>( <span class="dv">0</span>, <span class="dv">1</span> )
), <span class="dt">data =</span> d2 )</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="kw">precis</span>( m2 ) )</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-214"></span>
<img src="main_files/figure-html/unnamed-chunk-214-1.pdf" alt="mudeli koefitsientide plot" width="672" />
<p class="caption">
Joonis 8.35: mudeli koefitsientide plot
</p>
</div>
<p><strong>NB!</strong> Järgmised interpretatsioonid kehtivad ainult siis, kui mudeldame nullile tsentreeritud andmeid.</p>
<p>a - hdl-i oodatav keskväärtus siis kui võõ-ümbermõõt ja vanus on fikseeritud oma keskmistel väärtustel. bR - oodatav hdl-i muutus, kui vanus kasvab 1 aasta võrra ja võõ-ümbermõõt on fikseeritud oma keskväärtusel bA - sama, kui võõ-ümbermõõt kasvab 1 ühiku (inch) võrra bAR - kaks ekvivalentset tõlgendust: 1) oodatav muutus vanuse mõju määrale hdl-le, kui vöö-ümbermõõt kasvab 1 ühiku võrra. 2) oodatav muutus vöö-ümbermõõdu mõju määrale hdl-le, kui vanus kasvab 1 ühiku võrra.</p>
<p>Negatiivne bAR tähendab, et vanus ja vöö-ümbermõõt omavad vastandlikke mõjusid hdl-i tasemele, aga samas kumgki tõstab teise tähtsust hdl-le.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m3 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(
    <span class="kw">alist</span>(
        hdl <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(mu, sigma),
        mu &lt;-<span class="st"> </span>a <span class="op">+</span><span class="st"> </span>bR <span class="op">*</span><span class="st"> </span>age_st <span class="op">+</span><span class="st"> </span>bA <span class="op">*</span><span class="st"> </span>waist_st,
        a <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, <span class="dv">100</span>),
        <span class="kw">c</span>(bR, bA) <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, <span class="dv">2</span>),
        sigma <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>)
), <span class="dt">data =</span> d2)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">compare</span>(m2, m3)</code></pre></div>
<pre><code>##    WAIC pWAIC dWAIC weight    SE  dSE
## m3 3391   5.6   0.0   0.72 41.78   NA
## m2 3393   7.1   1.9   0.28 41.88 1.91</code></pre>
<p>Siin on tegelikult eelistatud ilma interaktsioonita mudel. Aga kuna interaktsioonimudeli kaal on ikkagi 28%, tasub meil ennustuste tegemisel mõlemat mudelit koos arvestada vastavalt oma kaalule.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">coeftab</span>(m2, m3)</code></pre></div>
<pre><code>##       m2      m3     
## a       50.43   50.40
## bR       1.12    1.09
## bA      -4.13   -4.10
## bAR     -0.54      NA
## sigma   16.64   16.63
## nobs      400     400</code></pre>
<p>Tõesti, bA ja bR on mõlemas mudelis väga sarnased. m3 on kindlasti lihtsamini tõlgendatav.</p>
<p>Ensemble teeb ära nii link()-i kui sim()-i, kasutades mõlemat mudelit vastavalt nende mudelite WAIC-i kaaludele ja toodab listi, mille elementideks on link() toodetud maatriks ja sim() toodetud maatriks.</p>
<p>Teeme 3 plotti: waist = 0 (keskmine), waist = -1 (miinus üks sd) ja waist = 1</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">waist_fun &lt;-<span class="st"> </span><span class="cf">function</span>(waist, ...) {
  d.pred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">age_st =</span> <span class="kw">seq</span>( <span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="dt">length.out =</span> <span class="dv">20</span> ),
                       <span class="dt">waist_st =</span> waist)
  e &lt;-<span class="st"> </span><span class="kw">ensemble</span>(..., <span class="dt">data =</span> d.pred)
  hdl &lt;-<span class="st"> </span><span class="kw">apply</span>(e<span class="op">$</span>link, <span class="dv">2</span>, mean)
  mu.PI &lt;-<span class="st"> </span><span class="kw">apply</span>(e<span class="op">$</span>link, <span class="dv">2</span>, PI, <span class="dt">prob =</span> <span class="fl">0.97</span>)
  <span class="kw">ggplot</span>(d.pred, <span class="kw">aes</span>(<span class="dt">x =</span> age_st)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> hdl)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>( <span class="kw">aes</span>(<span class="dt">y =</span> mu.PI[<span class="dv">1</span>,]), <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>( <span class="kw">aes</span>( <span class="dt">y =</span> mu.PI[<span class="dv">2</span>,] ), <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">ylim</span>(<span class="dv">40</span>, <span class="dv">70</span>)
}</code></pre></div>
<p>Ensemble mudel:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Fit ensemble model
<span class="co"># p &lt;- lapply(-1:1, waist_fun, m2, m3)</span>
## Plot three plots
<span class="co"># do.call(grid.arrange, c(p, ncol = 3))</span>
## 
p_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">waist_fun</span>(<span class="op">-</span><span class="dv">1</span>, m2, m3)
p0 &lt;-<span class="st"> </span><span class="kw">waist_fun</span>(<span class="dv">0</span>, m2, m3)
p1 &lt;-<span class="st"> </span><span class="kw">waist_fun</span>(<span class="dv">1</span>, m2, m3)
<span class="kw">grid.arrange</span>(p_<span class="dv">1</span>, p0, p1, <span class="dt">ncol =</span> <span class="dv">3</span>)</code></pre></div>
<pre><code>## Warning: Removed 2 rows containing missing values
## (geom_path).</code></pre>
<div class="figure"><span id="fig:unnamed-chunk-220"></span>
<img src="main_files/figure-html/unnamed-chunk-220-1.pdf" alt="Ennustusplot &lt;U+00FC&gt;le kahe mudeli." width="672" />
<p class="caption">
Joonis 8.36: Ennustusplot <U+00FC>le kahe mudeli.
</p>
</div>
<p>Ja sama ainult ühe mudeliga – m2.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">w0 &lt;-<span class="st"> </span><span class="kw">waist_fun</span>(<span class="op">-</span><span class="dv">1</span>, m2)
w_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">waist_fun</span>(<span class="dv">0</span>, m2)
w1 &lt;-<span class="st"> </span><span class="kw">waist_fun</span>(<span class="dv">1</span>, m2)
<span class="kw">grid.arrange</span>(w0, w_<span class="dv">1</span>, w1, <span class="dt">ncol =</span> <span class="dv">3</span>)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-221"></span>
<img src="main_files/figure-html/unnamed-chunk-221-1.pdf" alt="Ennustusplot m2-le." width="672" />
<p class="caption">
Joonis 8.37: Ennustusplot m2-le.
</p>
</div>
<p>Nüüd on hästi näha, et interaktsioonimudel laseb sirge tõusunurgad vabaks!</p>
<p>Üldiselt tasub interaktsioon mudelisse sisse kirjutada siis, kui see interaktsioon on teoreetiliselt mõtekas (ühe prediktori mõju võiks sõltuda teise prediktori tasemest). Interaktsiooni koefitsiendi määramine võib suurendada ebakindlust teiste parameetrite määramisel, seda eriti siis kui interaktsiooni parameeter on korreleeritud oma komponentide parameetritega (vt pairs(model)).</p>
<p>Isegi kui interaktsiooniparameetri posteerior hõlmab 0-i, tuleb interaktsiooni parameetrit mudelisse pannes arvestada, et individuaalsete prediktorite mõju ei saa summeerida pelgalt läbi nende koefitsientide. Selle asemel tuleb vaadata sirge tõusu erinevatel teiste prediktorite väärtustel (nagu eelneval joonisel)</p>
<p>Kui tavaline interaktsioonimudel on <span class="math inline">\(y = a + b1x1 + b2x2 + b3x1x2\)</span>, siis mis juhtub, kui meie mudel on <span class="math inline">\(y = b1x1 + b3x1x2\)</span>? See tähendab, et me surume b2 väärtuse nulli, mis võib ära rikkuda mudeli teiste parameetrite posteeriorid! Kui teil on alust arvata, et b2-l puudub otsene mõju y väärtusele (kuid tal on mõju b1 väärtusele), siis võib muidugi ka sellist mudelit kasutada. Aga see on haruldane juhtum.</p>
</div>
</div>
<div id="hierarhilised-mudelid" class="section level2">
<h2><span class="header-section-number">8.7</span> Hierarhilised mudelid</h2>
<p>Hierarhiline mudel kajastab sellise katse või vaatluse struktuuri, kus andmed ei grupeeru mitte ainult katse- ja kontrolltingimuste vahel, vaid ka nende gruppide sees klastritesse ehk alamgruppidesse. Näiteks, kui me mõõdame platseebo-kontrollitud uuringus kümmet patsienti ja teeme igale patsiendile viis kordusmõõtmist (kahetasemeline mudel). Või kui mõõdame kalamaksaõli mõju matemaatikaeksami tulemustele kümnes koolis, ja igas neist viies klassis (kolmetasemeline mudel). Tavapärane lähenemine oleks kõigepealt keskmistada andmed iga klassi sees ning seejärel keskmistada iga kooli sees (võtta igale koolile 5 klassi keskmine). Ning seejärel, võttes iga kooli keskmise üheks andmepunktiks, teha soovitud statistiline test (N = 10, sest meil on 10 kooli). Paraku, sellisel viisil talitades alahindame varieeruvust, mistõttu meie statistiline test alahindab ebakindluse määra arvutatud statistiku ümber. Hierarhilised mudelid, mis kajastavad adekvaatselt katse struktuuri, aitavad sellest murest üle saada. Üldine soovitus on, et kui teie katse struktuur seda võimaldab, siis peaksite alustama modelleerimist hierarhilistest mudelitest.</p>
<p>Hierarhilised mudelid on eriti kasulikud, kui teil on osades klastrites vähem andmepunkte kui teistes, sest nad vaatavad andmeid korraga nii klastrite vahel kui klastrite sees ning kannavad informatsiooni üle klastritest, kus on rohkem andmepunkte, nendesse klastritesse, kus on vähe andmeid. See parandab hinnangute täpsust.</p>
<blockquote>
<p>Hierarhilised mudelid modelleerivad eksplitsiitselt varieeruvust klasrtite sees ja klastrite vahel.</p>
</blockquote>
<div id="shrinkage" class="section level3">
<h3><span class="header-section-number">8.7.1</span> Shrinkage</h3>
<p>Oletame, et te plaanite reisi Kopenhaagenisse ja soovite sellega seoses teada, kui kallis on keskeltläbi õlu selle linna kõrtsides. Teile on teada õlle hind kolmes Kopenhaageni kõrtsis, mida ei ole just palju. Aga sellele lisaks on teile teada ka õlle hind 6-s Viini, 4-s Praha ja 5-s Pariisi kõrtsis. Nüüd on teil põhimõtteliselt kolm võimalust, kuidas sellele probleemile läheneda.</p>
<ol style="list-style-type: decimal">
<li><p>Te arvestate ainult Kopenhaageni andmeid ja ignoreerite teisi, kui ebarelevantseid. See meetod töötab hästi siis, kui teil on Kopenhaageni kohta palju andmeid (aga teil ei ole).</p></li>
<li><p>Te arvestate võrdselt kõiki andmeid, mis teil on — ehk te võtate keskmise kõikidest õllehindadest, hoolimata riigist. See töötab parimini siis, kui päriselt pole vahet, millisest riigist te oma õlle ostate, ehk kui õlu maksab igal pool sama palju. Antud juhul pole see ilmselt parim eeldus.</p></li>
<li><p>Te eeldate, et õlle hinna kujunemisel erinevates riikides on midagi ühist, aga et seal on ka erinevusi. Sellisel juhul tahate te fittida hierarhilise mudeli, kus teie hinnang õlle hinnale Kopenhaagenis sõltuks mingil määral (aga mitte nii suurel määral, kui eelmises punktis) ka teie kogemustest teistes linnades. Sama moodi, teie hinnang õlle hinnale Pariisis, Prahas jne hakkab mingil määral sõltuma kõikide linnade andmetest.</p></li>
</ol>
<blockquote>
<p>Kui teil on olukord, kus te mõõdate erinevaid gruppe, mis küll omavahel erinevad, aga on ka teatud määral sarnased (näiteks testitulemused grupeerituna kooli kaupa), siis on mõistlik kasutada kõikide gruppide andmeid, et adjusteerida iga grupi spetsiifilisi parameetreid. Seda adjusteerimise määra kutsutakse “shrinkage”.</p>
</blockquote>
<p>Shrinkage toimub parameetri keskväärtuse suunas ja mingi grupi shrinkage on seda suurem, mida vähem on selles grupis liikmeid ja mida kaugemal asub see grupp kõikide gruppide keskväärtusest. Shrinkage on põhimõtteliselt sama nähtus, mis juba Francis Galtoni poolt avastatud regressioon keskmisele. Regressioon keskmisele on stohhastiline protsess kus, olles sooritanud n mõõtmist ja arvutanud nende tulemuste põhjal efekti suuruse, see valimi ES peegeldab nii tegelikku ES-i kui juhuslikku valimiviga. Kui valimivea osakaal ES-s on suur, siis lisamõõtmised vähendavad keskeltläbi efekti suurust. Shrinkage erineb sellest ainult selle poolest, et lisamõõtmised meenutavad ainult <strong>osaliselt</strong> algseid mõõtmisi.</p>
<p>Kasutades hierarhilisi mudeleid saab edukalt võidelda ka <em>multiple testingu</em> ehk mitmese testimise probleemiga. See probleem on lihtsalt sõnastatav: kui te sooritate palju võrdluskatseid ja statistilisi teste olukorras, kus tegelik katseefekt on tühine, siis tänu valimiveale annavad osad teie paljudest testidest ülehinnatud efekti. Seega, kui meil on kahtlus, et enamus võrdlusi on “mõttetud” ja me ei oska ette ennustada, millised võrdlused neist (kui üldse mõni) võiks anda tõelise teaduslikult mõtteka efekti, siis on lahendus kõiki saadud efekte kunstlikult pisendada kõikide efektide keskmise suunas. Mudeli kontekstis kutsutakse sellist lähenemist <em>shrinkage</em>-ks. Aga kui suurel määral seda teha? See sõltub nii sellest, kui palju teste me teeme, valimi suurusest, kui ka sellest, kuidas jaotuvad mõõdetud efektisuurused (milline on efektisuuruste varieeruvus testide vahel).</p>
<p>Bayesi lahendus on, et me lisame mudelisse veel ühe hierarhilise priori, mis kõrgub üle gruppide-spetsiifilise priori. Seega anname me olemasolevale priorile uue kõrgema taseme meta-priori, mis tagab, et informatsiooni jagatakse gruppide vahel ja samal ajal ka gruppide sees. Sellise lahenduse õigustus on, et me usume, et erinevad alam-grupid pärinevad samast üli-jaotusest ja neil on omavahel midagi ühist (ehkki alam-gruppide vahel võib olla ka reaalseid erinevusi). Näiteks, et kõik klassid saavad oma lapsed samast lastepopulatsioonist, aga siiski, et leidub ka eriklasse eriti andekatele.</p>
<p>Selline mudel tagab, et samamoodi nagu mudeli ennustused individaalsete andmepunktide kohta iga alam-grupi sees “liiguvad lähemale” oma alam-grupi keskmisele, samamoodi liiguvad ka alam-gruppide keskmised lähemale üldisele grupi keskmisele. Selle positiivne mõju on valealarmide vähendamine ja oht on, et me kaotame ka tõelisi efekte. Bayesi eelis on, et see oht realiseerub ainult niipalju, kuipalju meie mudel ei kajasta reaalset katse struktuuri. Klassikalises statistikas rakendatavad multiple testingu korrektsioonid (Bonfferroni, ANOVA jt) on kõik teoreetiliselt kehvemad.</p>
<p>Lihtsaim shrinkage mudeli tüüp on mudel, kus me laseme vabaks interceptid, aga mitte tõusunurgad. Igale klastrile vastab mudelis oma intercepti parameeter ja oma intercepti prior. Lisaks annab mudel meile fittimise käigus valimi andmete põhjal ise parameetrid kõrgema taseme priorisse, mis on ühine kõikidele interceptidele. Seega me määrame korraga interceptide parameetrid ja kõrgema taseme priori parameetrid, mis tähendab, et informatsioon liigub mudelit fittides mõlemat pidi — mööda hierarhiat alt ülesse ja ülevalt alla. Selline mudel usub, et erinevate koolide keskmine tase erineb (seda näitab iga kooli intercept), aga juhul kui me mõõdame näiteks kalamaksaõli mõju õppeedukusele, siis selle mõju suurus ei erine koolide vahel (kõikide koolide tõusuparameetrid on identsed).</p>
</div>
<div id="anova-laadne-mudel" class="section level3">
<h3><span class="header-section-number">8.7.2</span> ANOVA-laadne mudel</h3>
<p>Lihtne ANOVA on sageduslik test, mis võrdleb gruppide keskmisi mitmese testimise kontekstis. Siin ehitame selle Bayesi analoogi, mis samuti hindab gruppide keskmisi mitmese testimise kontekstis. Põhiline erinevus seisneb selles, et kui ANOVA punktennustus iga grupi keskväärtusele võrdub valimi keskväärtusega ja ANOVA pelgalt kohandab usaldusintervalle selle keskväärtuse ümber, siis bayesiaanlik mudel püüab ennustada igale grupile selle tegelikku kõige tõenäolisemat keskväärtust arvestades kõigi gruppide andmeid. Shrinkage-i roll on ekstreemseid gruppe “tagasi tõmmates” vähendada ebakindlust iga grupi keskmise ennustuse ümber. Shrinkage käigus tõmmatakse gruppe kõikide gruppide keskmise poole seda tugevamalt, mida kaugemal nad sellest keskmisest on. Sellega kaasneb paratamatult mõningane süstemaatiline viga, kus tõelised efektid tulevad välja väiksematena, kui nad tegelikult on. Kui ilma tegelike efektideta gruppide arv on väga suur võrreldes päris efektidega gruppidega, siis võib shrinkage meie pärisefektid sootuks ära kaotada. Kahjuks on see loogiline paratamatus; alternatiiviks on olukord, kus meie üksikud pärisefektid upuvad sama suurte pseudoefektide merre.</p>
<p><em>The data contain GCSE exam scores on a science subject. Two components of the exam were chosen as outcome variables: written paper and course work. There are 1,905 students from 73 schools in England. Five fields are as follows.</em></p>
<ol style="list-style-type: decimal">
<li><p>School ID</p></li>
<li><p>Student ID</p></li>
<li><p>Gender of student</p></li>
</ol>
<p>0 = boy</p>
<p>1 = girl</p>
<ol start="4" style="list-style-type: decimal">
<li><p>Total score of written paper</p></li>
<li><p>Total score of coursework paper</p></li>
</ol>
<p>Missing values are coded as -1.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">schools &lt;-<span class="st"> </span><span class="kw">read.csv</span>( <span class="st">&quot;data/schools.csv&quot;</span>)
schools &lt;-<span class="st"> </span>schools <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">complete.cases</span>(.)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(sex, school), as.factor)</code></pre></div>
<p>Alustuseks mitte-hierarhiline mudel, mis arvutab keskmise score1 igale koolile eraldi. See on intercept-only mudel, mis tähendab, et me hindame testitulemuse keskväärtust kooli kaupa ja igale koolile sõltumatult kõigist teistest koolidest. Me ei püüa siin ennustada testitulemuste väärtusi x-i väärtuste põhjal. Selles mudelis on tavapärased ühetasemelised priorid, ainult mu on ümber nimetatud a_school-iks ja sellele on antud indeks [school], mis tähendab, et mudel arvutab a_school-i, ehk keskmise testitulemuse, igale koolile. Kuna siin puuduvad kõrgema taseme priorid, siis vaatab mudel igat kooli eraldi ja ühegi kooli hinnang ei arvesta ühegi teise kooli andmetega.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">schoolm2 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(
  <span class="kw">alist</span>(
    score1 <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(mu, sigma),
    mu &lt;-<span class="st"> </span>Intercept <span class="op">+</span><span class="st"> </span>v_Intercept[school],
    Intercept <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, <span class="dv">50</span>),
    v_Intercept[school] <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, <span class="dv">50</span>),
    sigma <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>, <span class="dv">2</span>)
  ), <span class="dt">data =</span> schools)</code></pre></div>
<p>Vaata koefitsente.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">precis</span>(schoolm2, <span class="dt">depth =</span> <span class="dv">2</span>)</code></pre></div>
<p>Igale koolile antud hinnang on sõltumatu kõigist teistest koolidest.</p>
<p>Ja nüüd hierarhiline mudel, mis teab koolide vahelisest varieeruvusest. Siin leiab a_school-i priorist teise taseme meta-parameetri nimega sigma_school, millele on defineeritud oma meta-prior.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">schoolm3 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(<span class="kw">alist</span>(
  score1 <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(mu, sigma),
  mu &lt;-<span class="st"> </span>Intercept <span class="op">+</span><span class="st"> </span>v_Intercept[school],
  Intercept <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, <span class="dv">50</span>),
  v_Intercept[school] <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, sigma_school),
  sigma_school <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>, <span class="dv">2</span>),
  sigma <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>, <span class="dv">2</span>)
), <span class="dt">data =</span> schools)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">precis</span>(schoolm3, <span class="dt">depth =</span> <span class="dv">2</span>)</code></pre></div>
<p>Nagu näha on sigma_school &lt; sigma, mis tähendab, et koolide vaheline varieeruvus on väiksem kui õpilaste vaheline varieeruvus neis koolides. Seega sõltub testi tulemus rohkem sellest, kes testi teeb kui sellest, mis koolis ta käib. Loogika on siin järgmine: samamoodi nagu testitulemustel on jaotus õpilasekaupa, on neil ka jaotus koolikaupa. Koolikaupa jaotus töötab priorina õpilasekaupa jaotusele. Aga samas vajab kooli kaupa jaotus oma priorit — ehk meta-priorit. Seega saame me samast mudelist hinnangu nii testitulemustele kõikvõimalike õpilaste lõikes, kui ka kõikvõimalike koolide lõikes. Mudel ennustab ka nende koolide ja õpilaste tulemusi, keda tegelikult olemas ei ole, aga kes võiksid kunagi sündida.</p>
<p>Ning veel üks hierarhiline mudel, mis teab nii koolide skooride keskmiste varieeruvust kui koolide vahelist varieeruvust.</p>
<p>Võrdleme mudeleid.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">compare</span>(schoolm2, schoolm3)</code></pre></div>
<p>Siit nähtub, et m3 on parim mudel, aga ka m2 omab mingit kaalu.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="kw">coeftab</span>(schoolm2, schoolm3))</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-230"></span>
<img src="main_files/figure-html/unnamed-chunk-230-1.pdf" alt="mudelite koefitsiendid." width="672" />
<p class="caption">
Joonis 8.38: mudelite koefitsiendid.
</p>
</div>
<p>Siin on hästi näha shrinkage m3 puhul võrreldes m2-ga, mis ei tee multiple testingu korrektsiooni. Nende koolide puhul, kus usaldusintervall on laiem, on ka suurem shrinkage (mudel võtab nende kohta suhteliselt rohkem infot teistest koolidest sest need koolid ise on mingil põhjusel suhteliselt infovaesed).</p>
</div>
<div id="vabad-interceptid-klassikalises-regressioonimudelis" class="section level3">
<h3><span class="header-section-number">8.7.3</span> Vabad interceptid klassikalises regressioonimudelis</h3>
<p>Ennustame score1 sõltuvust sex-ist. Küsimus: kui palju poiste ja tüdrukute matemaatikaoskused erinevad? Fitime mudeli, mis laseb vabaks intercepti. <strong>Selle mudeli eeldus on, et igal koolil on oma baastase (oma intercept), aga kõikide koolide efektid (mudeli tõusu-koefitsient) on identsed.</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">psych<span class="op">::</span><span class="kw">describe</span>(schools)</code></pre></div>
<pre><code>##         vars    n    mean      sd median trimmed
## school*    1 1523   38.36   19.98   40.0   38.84
## student    2 1523 1016.45 1836.14  129.0  628.65
## sex*       3 1523    1.59    0.49    2.0    1.61
## score1     4 1523   46.50   13.48   46.0   46.68
## score2     5 1523   73.38   16.44   75.9   74.65
##            mad  min  max   range  skew kurtosis    se
## school*  23.72 1.00   73   72.00 -0.18    -1.08  0.51
## student 124.54 1.00 5516 5515.00  1.69     0.98 47.05
## sex*      0.00 1.00    2    1.00 -0.37    -1.87  0.01
## score1   13.34 0.60   90   89.40 -0.12    -0.05  0.35
## score2   16.46 9.25  100   90.75 -0.75     0.51  0.42</code></pre>
<p>Me kasutame prediktorina binaarset kategoorilist muutujat. See on analoogiline olukord ANOVA mudelile, mis võtab arvesse multiple testingu olukorra, mis meil siin on.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">schools_f1 &lt;-<span class="st"> </span><span class="kw">glimmer</span>(score1 <span class="op">~</span><span class="st"> </span>sex <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>school), <span class="dt">data =</span> schools)</code></pre></div>
<pre><code>## alist(
##     score1 ~ dnorm( mu , sigma ),
##     mu &lt;- Intercept +
##         b_sex1*sex1 +
##         v_Intercept[school],
##     Intercept ~ dnorm(0,10),
##     b_sex1 ~ dnorm(0,10),
##     v_Intercept[school] ~ dnorm(0,sigma_school),
##     sigma_school ~ dcauchy(0,2),
##     sigma ~ dcauchy(0,2)
## )</code></pre>
<p>Kuna glimmeri priorite parametriseeringud on vales skaalas (liiga väikesed), muudame neid nii, et intercept (keskmine testitulemus üle koolide) oleks tsentreeritud 50-le (max testi tulemus on 100) ja standardhälve on 20. Igaks juhuks tõstame veidi ka beta koefitsiendi priori sigmat. v_intercept peaks olema alati nullile tsentreeritud.</p>
<p>Glimmeri väljundis on sama palju koolide veerge, kui palju on erinevaid koole, miinus üks. Selline binaarne numbriline väljund on Stani-le vajalik. Seega ei saa me faktortunnuste korral kasutada algset andmetabelit.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(schools_f1<span class="op">$</span>d)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">schools_m1 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(<span class="kw">alist</span>(
    score1 <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>( mu , sigma ),
    mu &lt;-<span class="st"> </span>Intercept <span class="op">+</span><span class="st"> </span>b_sex1<span class="op">*</span>sex1 <span class="op">+</span><span class="st"> </span>v_Intercept[school],
    Intercept <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">50</span>, <span class="dv">20</span>),
    b_sex1 <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, <span class="dv">15</span>),
    v_Intercept[school] <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, sigma_school),
    sigma_school <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>,<span class="dv">2</span>),
    sigma <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>,<span class="dv">2</span>)
), <span class="dt">data =</span> schools_f1<span class="op">$</span>d) <span class="co"># use the data table generated by glimmer() </span>
<span class="co">#glimmer converts factors to Stan-eatable form.</span></code></pre></div>
<p>Siin on v_Intercept kooli-spetsiifiline korrektsioonifaktor, mis tuleb liita üldisele Interceptile. mean(v_Intercept) == 0. Me eeldame, et korrektsioonid on normaaljaotusega. Alternatiivne viis seda mudelit kirjutada oleks <code>mu &lt;- Intercept[school] + b_sex1*sex1</code> ja see töötab smamoodi (nüüd on iga kooli intercept kohe eraldi).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="kw">precis</span>(schools_m1, <span class="dt">depth =</span> <span class="dv">2</span>))</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-236"></span>
<img src="main_files/figure-html/unnamed-chunk-236-1.pdf" alt="Mudeli koefitsiendid" width="672" />
<p class="caption">
Joonis 8.39: Mudeli koefitsiendid
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">precis</span>(schools_m1)</code></pre></div>
<pre><code>## 73 vector or matrix parameters omitted in display. Use depth=2 to show them.</code></pre>
<pre><code>##               Mean StdDev lower 0.89 upper 0.89 n_eff
## Intercept    49.21   0.98      47.89      51.01   227
## b_sex1       -2.44   0.60      -3.37      -1.52  1000
## sigma_school  7.06   0.71       5.87       8.09  1000
## sigma        11.18   0.20      10.85      11.50  1000
##              Rhat
## Intercept       1
## b_sex1          1
## sigma_school    1
## sigma           1</code></pre>
<p>sex = 1 ehk sex1 on tüdruk.</p>
<p>Intercept annab siin sex = 0 (poisid) keskmise skoori kooli kaupa (kui liita üldisele interceptile kooli-spetsiifiline intercept). Kui tahame näiteks hinnangut 2. kooli tüdrukute skoorile (ehk tõelisele matemaatikavõimekusele) siis:</p>
<p><code>Intercept + b_sex1 + intercept[2]</code></p>
<p>annab meile selle posteeriori. Poistele sama 2. kooli kohta:</p>
<p><code>Intercept + intercept[2]</code></p>
<p>Ja poiste-tüdrukute erinevus skooripunktides võrdub</p>
<p><code>b_sex1</code></p>
<p>Arvutame siis kooli nr 2 tüdrukute keskmise skoori posteeriori.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">schools_m1_samples &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(schools_m1<span class="op">@</span>stanfit)
school_2_girls &lt;-<span class="st"> </span>schools_m1_samples<span class="op">$</span>Intercept <span class="op">+</span><span class="st"> </span>
<span class="st">  </span>schools_m1_samples<span class="op">$</span>b_sex1 <span class="op">+</span><span class="st"> </span>
<span class="st">  </span>schools_m1_samples<span class="op">$</span><span class="st">`</span><span class="dt">v_Intercept[2]</span><span class="st">`</span>
## Plot density histogram of intercepts
<span class="kw">dens</span>(school_2_girls)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-238"></span>
<img src="main_files/figure-html/unnamed-chunk-238-1.pdf" alt="T&lt;U+00FC&gt;drukute skoori posteerior" width="288" />
<p class="caption">
Joonis 8.40: T<U+00FC>drukute skoori posteerior
</p>
</div>
<p>Ja Poiste oma</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">school_2_boys &lt;-<span class="st"> </span>schools_m1_samples<span class="op">$</span>Intercept <span class="op">+</span><span class="st"> </span>
<span class="st">  </span>schools_m1_samples<span class="op">$</span><span class="st">`</span><span class="dt">v_Intercept[2]</span><span class="st">`</span>
## Plot density histogram of intercepts
<span class="kw">dens</span>(school_2_boys)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-239"></span>
<img src="main_files/figure-html/unnamed-chunk-239-1.pdf" alt="Poiste skoori posteerior." width="288" />
<p class="caption">
Joonis 8.41: Poiste skoori posteerior.
</p>
</div>
<p>Siin on eeldus, et kõikides koolides on sama poiste ja tüdrukute vaheline erinevus (b_sex1), kuid erinevad matemaatikateadmiste baastasemed (mudeli intercept on koolide vahel vabaks lastud, kuid tõus mitte).</p>
</div>
<div id="vabad-tousud-ja-interceptid" class="section level3">
<h3><span class="header-section-number">8.7.4</span> Vabad tõusud ja interceptid</h3>
<p>Milline näeb välja mudel, kus me laseme vabaks nii intercepti kui tõusu?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">schools_f2 &lt;-<span class="st"> </span><span class="kw">glimmer</span>(score1 <span class="op">~</span><span class="st"> </span>sex <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>sex <span class="op">|</span><span class="st"> </span>school), <span class="dt">data =</span> schools)</code></pre></div>
<pre><code>## alist(
##     score1 ~ dnorm( mu , sigma ),
##     mu &lt;- Intercept +
##         b_sex1*sex1 +
##         v_Intercept[school] +
##         v_sex1[school]*sex1,
##     Intercept ~ dnorm(0,10),
##     b_sex1 ~ dnorm(0,10),
##     c(v_Intercept,v_sex1)[school] ~ dmvnorm2(0,sigma_school,Rho_school),
##     sigma_school ~ dcauchy(0,2),
##     Rho_school ~ dlkjcorr(2),
##     sigma ~ dcauchy(0,2)
## )</code></pre>
<p>nüüd on meil lisaparameetrid v_sex1, mis annab tõusu igale koolile eraldi ning Rho-school, mis annab korrelatsiooni intercepti ja tõusu vahel. Nüüd me jagame informatsiooni erinevat tüüpi parameetrite, nimelt interceptide ja tõusude, vahel. Selleks ongi vaja Rho lisa-parameetrit. Nüüd ei modelleeri me intercepti ja tõusu enam 2 eraldi normaaljaotuste abil vaid ühe 2-dimensionaalse normaaljaotusega (mvnorm2).</p>
<p>Prior korrelatsioonile Interceptide ja tõusude vahel on <code>rethinking::lkjcorr()</code>. Selle ainus parameeter on K. Mida suurem K, seda rohkem on prior konsentreeritud 0 korrelatsiooni ümber. K = 1 annab tasase priori. Meie kasutame K = 2, mis töötab laia vahemiku mudelitega.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">R &lt;-<span class="st"> </span><span class="kw">rlkjcorr</span>(<span class="fl">1e4</span>, <span class="dt">K =</span> <span class="dv">2</span>, <span class="dt">eta =</span> <span class="dv">2</span>)
<span class="kw">dens</span>(R[, <span class="dv">1</span>, <span class="dv">2</span>] , <span class="dt">xlab =</span> <span class="st">&quot;correlation&quot;</span>)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-241"></span>
<img src="main_files/figure-html/unnamed-chunk-241-1.pdf" alt="Korrelatsiooni prior on n&lt;U+00F5&gt;rgalt informatiivne -- suunab posteeriori eemale ekstreemsetest korrelatsioonidest." width="288" />
<p class="caption">
Joonis 8.42: Korrelatsiooni prior on n<U+00F5>rgalt informatiivne – suunab posteeriori eemale ekstreemsetest korrelatsioonidest.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">schools_m2 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(<span class="kw">alist</span>(
    score1 <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>( mu , sigma ),
    mu &lt;-<span class="st"> </span>Intercept <span class="op">+</span>
<span class="st">        </span>b_sex1<span class="op">*</span>sex1 <span class="op">+</span>
<span class="st">        </span>v_Intercept[school] <span class="op">+</span>
<span class="st">        </span>v_sex1[school]<span class="op">*</span>sex1,
    Intercept <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">50</span>, <span class="dv">20</span>),
    b_sex1 <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, <span class="dv">20</span>),
    <span class="kw">c</span>(v_Intercept,v_sex1)[school] <span class="op">~</span><span class="st"> </span><span class="kw">dmvnorm2</span>(<span class="dv">0</span>, sigma_school, Rho_school),
    sigma_school <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>,<span class="dv">2</span>),
    Rho_school <span class="op">~</span><span class="st"> </span><span class="kw">dlkjcorr</span>(<span class="dv">2</span>),
    sigma <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>,<span class="dv">2</span>)
), schools_f2<span class="op">$</span>d)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="kw">precis</span>(schools_m2, <span class="dt">depth =</span> <span class="dv">2</span>))</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-244"></span>
<img src="main_files/figure-html/unnamed-chunk-244-1.pdf" alt="Mudeli m2 koefitsiendid." width="480" />
<p class="caption">
Joonis 8.43: Mudeli m2 koefitsiendid.
</p>
</div>
<p>Posteerior korrelatsioonile intercepti ja tõusu vahel:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">schools_m2_samples &lt;-<span class="st"> </span><span class="kw">extract.samples</span>(schools_m2)
df1 &lt;-<span class="st"> </span>schools_m2_samples<span class="op">$</span>Rho_school <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.data.frame</span>()
<span class="co">#df1 #corr matrix- we need only the V2 col</span>
<span class="kw">dens</span>(df1<span class="op">$</span>V2)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-245"></span>
<img src="main_files/figure-html/unnamed-chunk-245-1.pdf" alt="Posteerior korrelatsioonile intercepti ja t&lt;U+00F5&gt;usu vahel." width="288" />
<p class="caption">
Joonis 8.44: Posteerior korrelatsioonile intercepti ja t<U+00F5>usu vahel.
</p>
</div>
<p>Meil on negatiivne korrelatsioon intercepti ja tõusu vahel. Seega, mida väiksem on poiste keskmine skoor koolis (=intercept), seda suurem om erinevus poiste ja tüdrukute skooride vahel (= tõus).</p>
<p>Nüüd saab 2. kooli skoori tüdrukutele valemiga:</p>
<p><em>Intercept + b_sex1 + v_intercept[2] + v_sex1[2]</em></p>
<p>Sama skoor poistele:</p>
<p><em>Intercept + v_intercept[2]</em></p>
<p>ja tüdrukute ja poiste erinevus 2. koolile:</p>
<p><em>b_sex1 + v_sex1[2]</em></p>
<p>tüdrukute-poiste erinevus üle kõikide koolide:</p>
<p><em>b_sex1</em></p>
<p>tüdrukute keskmine skoor üle kõikide koolide:</p>
<p><em>Intercept + b_sex1</em></p>
<p>ja poiste keskmine skoor üle kõikide koolide:</p>
<p><em>Intercept</em></p>
<p>Tõmbame mudelist ennustused 1., 2. ja 37. kooli poiste skooridele järgmisel semestril:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d.pred &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">school =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">37</span>),
  <span class="dt">sex1 =</span> <span class="dv">0</span>
)

schools_sim &lt;-<span class="st"> </span>rethinking<span class="op">::</span><span class="kw">sim</span>(schoolm2, <span class="dt">data =</span> d.pred) </code></pre></div>
<pre><code>## [ 100 / 1000 ]
[ 200 / 1000 ]
[ 300 / 1000 ]
[ 400 / 1000 ]
[ 500 / 1000 ]
[ 600 / 1000 ]
[ 700 / 1000 ]
[ 800 / 1000 ]
[ 900 / 1000 ]
[ 1000 / 1000 ]</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pred.p &lt;-<span class="st"> </span><span class="kw">apply</span>(schools_sim, <span class="dv">2</span>, mean)
pred.p.PI &lt;-<span class="st"> </span><span class="kw">apply</span>(schools_sim, <span class="dv">2</span> , PI)</code></pre></div>
<p>NB! kasutades <code>rethinking::sim()</code> saame me enustused andmepunktide (üksikute poiste tasemel). Antud juhul jääb ennustuse kohaselt esimeses koolis 89% individuaalseid skoore vahemikku 61-132 punkti 200-st võimalikust.</p>
<p>Kui meid huvitab hoopis nende koolide keskmine skoor järgmisel semestril, siis kasuta <code>rethinking::sim()</code> asemel <code>rethinking::link()</code> funktsiooni.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">schools_sim &lt;-<span class="st"> </span><span class="kw">link</span>(schools_m2, <span class="dt">data =</span> d.pred) </code></pre></div>
<pre><code>## [ 100 / 1000 ]
[ 200 / 1000 ]
[ 300 / 1000 ]
[ 400 / 1000 ]
[ 500 / 1000 ]
[ 600 / 1000 ]
[ 700 / 1000 ]
[ 800 / 1000 ]
[ 900 / 1000 ]
[ 1000 / 1000 ]</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pred.p &lt;-<span class="st"> </span><span class="kw">apply</span>(schools_sim, <span class="dv">2</span>, mean)
pred.p.PI &lt;-<span class="st"> </span><span class="kw">apply</span>(schools_sim, <span class="dv">2</span>, PI)
pred.p.PI</code></pre></div>
<pre><code>##      [,1]  [,2]  [,3]
## 5%  32.62 34.44 44.26
## 94% 46.22 39.91 49.70</code></pre>
<p>Esimeses koolis jääb keskmine poiste skoor 89% tõenäosusega vahemikku 33 kuni 46 punkti.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">compare</span>(schools_m1, schools_m2)</code></pre></div>
<pre><code>##             WAIC pWAIC dWAIC weight    SE  dSE
## schools_m1 11734  55.8   0.0    0.7 57.17   NA
## schools_m2 11736  60.8   1.7    0.3 57.22 1.38</code></pre>
<p>Tundub, et tõusude vabakslaskmine oli hea mõte. Ma saan hästi pihta, et erinevad koolid õpetavad matemaatikat erineva kvaliteediga. Aga miks peaks erinevates Inglismaa koolides olema erinev vahe poiste ja tüdrukute matemaatikateadmistel? Kas olukorras kus meil on hea kool, läheb see vahe väiksemaks või suuremaks? Tehke kindlaks!!! võrrelge graafiku slope vs. intercept.</p>
<div class="figure"><span id="fig:unnamed-chunk-249"></span>
<img src="main_files/figure-html/unnamed-chunk-249-1.pdf" alt="mida suurem on koolis poiste skoor, seda v&lt;U+00E4&gt;iksem on poiste ja t&lt;U+00FC&gt;drukute erinevus" width="384" />
<p class="caption">
Joonis 8.45: mida suurem on koolis poiste skoor, seda v<U+00E4>iksem on poiste ja t<U+00FC>drukute erinevus
</p>
</div>
<p>Tõepoolest: mida suurem on koolis poiste skoor (parem kool), seda väiksem on poiste ja tüdrukute erinevus. Aga seos on kaunis nõrk!</p>
<p>Muide sel joonisel tähendavad negatiivsed väärtused alla keskmist väärtust, mitte tingimata negatiivset erinevust või negatiivset skoori. Miks?</p>
<p>Arvutage nüüd poiste ja tüdrukute keskmine skoor kooli kaupa ja vaadake uuesti sõltuvust samasse erinevusesse. Mis on õigem viis: kas fittida ilma interceptita mudel (nagu eelmises peatükis) ja kasutada otse selle koefitsiente või kasutada meie m2 mudelit ning arvutada selle mudeli koefitsientide põhjal uus statistik (kaalutud keskmine näiteks)? Miks?</p>
</div>
<div id="hierarhiline-mudel-pidevate-prediktoritega" class="section level3">
<h3><span class="header-section-number">8.7.5</span> Hierarhiline mudel pidevate prediktoritega</h3>
<p>Siin püüame ennustada score1 mõju score2 väärtusele.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(schools<span class="op">$</span>score2, schools<span class="op">$</span>score1)
<span class="kw">abline</span>(<span class="kw">lm</span>(score1 <span class="op">~</span><span class="st"> </span>score2, <span class="dt">data =</span> schools))</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-250"></span>
<img src="main_files/figure-html/unnamed-chunk-250-1.pdf" alt="score1 vs. score2" width="384" />
<p class="caption">
Joonis 8.46: score1 vs. score2
</p>
</div>
<p>Kõigepealt lihtne regressioon <code>lm()</code> funktsiooniga (see ei ole hierarhiline mudel).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">lm</span>(score1 <span class="op">~</span><span class="st"> </span>score2, <span class="dt">data =</span> schools)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = score1 ~ score2, data = schools)
## 
## Coefficients:
## (Intercept)       score2  
##      17.971        0.389</code></pre>
<p>score2 tõus 1 punkti võrra tõstab score1-e 0.39 punkti võrra.</p>
<p>Modelleerime seost üle Bayesi hierarhilise mudeli, kus ainult Intercept on vabaks lastud.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glimmer</span>(score1 <span class="op">~</span><span class="st"> </span>score2 <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>school), <span class="dt">data =</span> schools)</code></pre></div>
<pre><code>## alist(
##     score1 ~ dnorm( mu , sigma ),
##     mu &lt;- Intercept +
##         b_score2*score2 +
##         v_Intercept[school],
##     Intercept ~ dnorm(0,10),
##     b_score2 ~ dnorm(0,10),
##     v_Intercept[school] ~ dnorm(0,sigma_school),
##     sigma_school ~ dcauchy(0,2),
##     sigma ~ dcauchy(0,2)
## )</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">schoolm7 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(<span class="kw">alist</span>(
    score1 <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(mu, sigma),
    mu &lt;-<span class="st"> </span>Intercept <span class="op">+</span>
<span class="st">        </span>b_score2 <span class="op">*</span><span class="st"> </span>score2 <span class="op">+</span>
<span class="st">        </span>v_Intercept[school],
    Intercept <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">50</span>, <span class="dv">50</span>),
    b_score2 <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, <span class="dv">10</span>),
    v_Intercept[school] <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, sigma_school),
    sigma_school <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>, <span class="dv">2</span>),
    sigma <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>, <span class="dv">2</span>)
), <span class="dt">data =</span> schools)</code></pre></div>
<p>Siin ei ole individuaalsed interceptid tõlgenduslikult informatiivsed, aga nende sissepanek parandab mudeli ennustust beta koefitsiendile (beta läheb väiksemaks ja ebakindlus selle hinnangu ümber kasvab).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">precis</span>(schoolm7, <span class="dt">depth =</span> <span class="dv">2</span>)</code></pre></div>
<p>Siin tuleb beta veidi väiksem - 0.36. Kuna sigma_school &lt; sigma, siis tundub, et koolide vaheline varieeruvus on väiksem kui laste vaheline varieeruvus (sigma on üle kõigi koolide). iga kooli baastase tuleb Intercept + v_Intercept[] aga selle mudeli järgi on kõikide koolide score2 ja score1 sõltuvus sama tugevusega.</p>
<p>Laseme siis ka tõusud vabaks</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glimmer</span>(score1 <span class="op">~</span><span class="st"> </span>score2 <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st">  </span>score2 <span class="op">|</span><span class="st"> </span>school), <span class="dt">data =</span> schools)</code></pre></div>
<pre><code>## alist(
##     score1 ~ dnorm( mu , sigma ),
##     mu &lt;- Intercept +
##         b_score2*score2 +
##         v_Intercept[school] +
##         v_score2[school]*score2,
##     Intercept ~ dnorm(0,10),
##     b_score2 ~ dnorm(0,10),
##     c(v_Intercept,v_score2)[school] ~ dmvnorm2(0,sigma_school,Rho_school),
##     sigma_school ~ dcauchy(0,2),
##     Rho_school ~ dlkjcorr(2),
##     sigma ~ dcauchy(0,2)
## )</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">schoolm5 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(<span class="kw">alist</span>(
    score1 <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>( mu , sigma ),
    mu &lt;-<span class="st"> </span>Intercept <span class="op">+</span><span class="st"> </span>b_score2 <span class="op">*</span><span class="st"> </span>score2 <span class="op">+</span><span class="st"> </span>
<span class="st">      </span>v_Intercept[school] <span class="op">+</span><span class="st"> </span>
<span class="st">      </span>v_score2[school] <span class="op">*</span><span class="st"> </span>score2,
    Intercept <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">50</span>, <span class="dv">25</span>),
    b_score2 <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, <span class="dv">10</span>),
    <span class="kw">c</span>(v_Intercept, v_score2)[school] <span class="op">~</span><span class="st"> </span><span class="kw">dmvnorm2</span>(<span class="dv">0</span>, sigma_school, Rho_school),
    sigma_school <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>, <span class="dv">2</span>),
    Rho_school <span class="op">~</span><span class="st"> </span><span class="kw">dlkjcorr</span>(<span class="dv">2</span>),
    sigma <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>, <span class="dv">2</span>)
), <span class="dt">data =</span> schools)</code></pre></div>
<p>nüüd saame igale koolile arvutada oma intercepti ja oma tõusu (ikka samamoodi: Intercept + v_intercept[] ja b_score2 + v_score2[])</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">precis</span>(schoolm5, <span class="dt">depth =</span> <span class="dv">2</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">schoolm6 &lt;-<span class="st"> </span><span class="kw">map2stan</span>(<span class="kw">alist</span>(
  score1 <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(mu , sigma),
  mu &lt;-<span class="st"> </span>Intercept <span class="op">+</span><span class="st"> </span>b_score2 <span class="op">*</span><span class="st"> </span>score2,
  Intercept <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">50</span>, <span class="dv">50</span>),
  b_score2 <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(<span class="dv">0</span>, <span class="dv">10</span>),
  sigma <span class="op">~</span><span class="st"> </span><span class="kw">dcauchy</span>(<span class="dv">0</span>, <span class="dv">2</span>)
), <span class="dt">data =</span> schools)</code></pre></div>
<p>m2 on selgelt parem mudel, kuigi m3 hinnangud interceptidele on suurema ebakindlusega. beta on nyyd 0.35</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">compare</span>(schoolm7, schoolm6, schoolm5)</code></pre></div>
<pre><code>##           WAIC pWAIC dWAIC weight    SE   dSE
## schoolm5 11380  78.4   0.0      1 56.37    NA
## schoolm7 11416  59.5  35.5      0 55.95 11.55
## schoolm6 11862   3.3 482.0      0 54.65 41.62</code></pre>
<p>0-mudel, mis on kõige kehvem, on kõige suurema betaga ja kõige väiksema ebakindlusega selle ümber. See on tavaline — hierarhiline mudel modelleerib ebakindlust paremini (realistlikumalt) ja vähendab üle-fittimise ohtu (beta tuleb selle võrra väiksem).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">precis</span>(schoolm7, <span class="dt">depth =</span> <span class="dv">2</span>)</code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="mudelite-keel.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="sonastik.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/lunr.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstats-tartu/lectures/edit/master/08_pidev.Rmd",
"text": "Edit"
},
"download": ["main.pdf", "main.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
